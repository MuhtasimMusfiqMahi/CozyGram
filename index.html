<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="color-scheme" content="light" />
  <title>CozyGram ‚Äî Cloud</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Fraunces:opsz,wght@9..144,600;800&display=swap" rel="stylesheet">

  <style>
    /* --- COZY DESIGN SYSTEM --- */
    :root {
      --cream: #fbf5ea; --paper: #fffaf1; --ink: #2b2b35;
      --shadow: rgba(25, 20, 35, .12); --shadow2: rgba(25, 20, 35, .06);
      --mood-a: rgba(247,197,159,.55); --mood-b: rgba(134,166,139,.35); --mood-c: rgba(219,161,168,.22);
      --mood-bg1: #fff5ea; --mood-bg2: #fbf5ea; --mood-bg3: #f7f0e6;
      --safe-bottom: env(safe-area-inset-bottom, 0px); --safe-top: env(safe-area-inset-top, 0px);
    }

    body {
      font-family: Nunito, ui-sans-serif, system-ui, -apple-system, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 800px at 25% 0%, var(--mood-a), rgba(251,245,234,0) 60%),
        radial-gradient(900px 650px at 85% 10%, var(--mood-b), rgba(251,245,234,0) 65%),
        radial-gradient(1000px 700px at 60% 90%, var(--mood-c), rgba(251,245,234,0) 58%),
        linear-gradient(180deg, var(--mood-bg1) 0%, var(--mood-bg2) 35%, var(--mood-bg3) 100%);
      -webkit-tap-highlight-color: transparent;
      min-height: 100vh;
      position: relative;
    }

    .paper-noise {
      background: radial-gradient(circle at 20% 10%, rgba(0,0,0,.03) 0 1px, transparent 2px),
                  radial-gradient(circle at 70% 35%, rgba(0,0,0,.02) 0 1px, transparent 2px);
      background-size: 120px 120px, 160px 160px;
      background-color: var(--paper);
    }

    .hand-card {
      border-radius: 26px 22px 28px 20px;
      box-shadow: 0 18px 40px var(--shadow), 0 3px 10px var(--shadow2);
      border: 1px solid rgba(43,43,53,.08);
    }

    .hand-outline { position: relative; }
    .hand-outline:before {
      content:""; position:absolute; inset:-2px; border-radius: 28px 22px 26px 24px;
      border: 2px solid rgba(43,43,53,.10); transform: rotate(-0.35deg); pointer-events:none;
    }

    /* ANIMATIONS */
    .wobbly { transition: transform .18s ease, filter .18s ease; }
    .wobbly:hover { transform: translateY(-2px) rotate(-0.25deg); filter: saturate(1.02); }
    .wobbly:active { transform: translateY(0px) scale(.99); }
    
    .wiggle { animation: wiggle .7s ease; }
    @keyframes wiggle { 
      0% { transform: rotate(0);} 
      30% { transform: rotate(-3deg);} 
      70% { transform: rotate(2deg);} 
      100% { transform: rotate(0);} 
    }

    .nav-pill {
      border-radius: 18px 18px 22px 16px;
      box-shadow: 0 8px 18px rgba(25,20,35,.10); border: 1px solid rgba(43,43,53,.08);
      background: linear-gradient(180deg, rgba(255,250,241,.9), rgba(255,250,241,.75));
      backdrop-filter: blur(10px);
    }

    .ink-line { stroke: rgba(43,43,53,.78); stroke-width: 2.2; stroke-linecap: round; stroke-linejoin: round; }
    .ink-line-lite { stroke: rgba(43,43,53,.55); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

    .badge-dot { width: 10px; height: 10px; border-radius: 999px; background: #f06d6d; box-shadow: 0 6px 14px rgba(240,109,109,.35); border: 2px solid rgba(255,250,241,.95); }

    @keyframes stickerFly { 
      0% { transform: translate(-10px, 10px) scale(.6) rotate(-8deg); opacity:0; } 
      20% { opacity:1; } 
      100% { transform: translate(-25px, -55px) scale(1.05) rotate(8deg); opacity:0; } 
    }
    .sticker-fly { position: absolute; animation: stickerFly 900ms ease-out forwards; pointer-events: none; z-index: 9999; }
    .sticker-fly svg { width: 48px; height: 48px; drop-shadow: 0 4px 6px rgba(0,0,0,0.1); }

    .pop-in { animation: pop .28s ease-out; }
    @keyframes pop { from { transform: translateY(10px) scale(.98); opacity:0;} to { transform: translateY(0) scale(1); opacity:1;} }
    .floaty { animation: floaty 4.6s ease-in-out infinite; }
    @keyframes floaty { 0%,100% { transform: translateY(0);} 50% { transform: translateY(-6px);} }
    .pageflip { transform-origin: left center; animation: pageflip .35s cubic-bezier(.2,.9,.2,1); }
    @keyframes pageflip { from { transform: perspective(900px) rotateY(-16deg); opacity:0.0; } to { transform: perspective(900px) rotateY(0deg); opacity:1; } }

    .hidden { display: none !important; }
    .main-safe-pad { padding-bottom: calc(7.5rem + var(--safe-bottom)); }
    .nav-safe { bottom: calc(1rem + var(--safe-bottom)); }
    .fab-safe { bottom: calc(5.75rem + var(--safe-bottom)); }
    .modal-safe { padding-bottom: calc(1rem + var(--safe-bottom)); padding-top: calc(1rem + var(--safe-top)); }
    .modal-card { max-height: min(820px, calc(100dvh - 2rem - var(--safe-bottom))); overflow: auto; }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    @media (min-width: 1024px) {
      #app { max-width: 1200px; padding-left: 7.5rem; padding-right: 1.5rem; }
      #bottomNav { left: 1.25rem; right: auto; top: 50%; bottom: auto; transform: translateY(-50%); width: 120px; }
      #bottomNav .navGrid { display: grid; grid-template-columns: 1fr; gap: .75rem; }
      #fab { left: auto; right: 1.5rem; bottom: 1.5rem; transform: none; }
      .desktop-two-col { display: grid; grid-template-columns: 320px 1fr; gap: 1rem; }
    }
    
    
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-thumb { background: rgba(43,43,53,.12); border-radius: 999px; }
  </style>
</head>
<body>

  <!-- HIDDEN INPUT FOR AVATARS (MUST BE BEFORE SCRIPT) -->
  <input id="avatarFileInput" type="file" accept="image/*" class="hidden" />

  <!-- ONBOARDING MODAL -->
  <div id="onboardingModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-[2px] hidden p-4 modal-safe" data-overlay>
    <div class="w-full max-w-md hand-card hand-outline paper-noise p-4 pop-in modal-card" role="dialog">
        <div class="flex items-start justify-between gap-3 mb-4">
            <div class="flex items-start gap-3">
                <div id="mascot" class="w-14 h-14 rounded-[22px_18px_26px_16px] bg-gradient-to-br from-[#86a68b] via-[#fbf5ea] to-[#f4a37a] border border-black/10 grid place-items-center floaty">
                    <svg class="w-9 h-9" viewBox="0 0 64 64" aria-hidden="true"><path class="ink-line" fill="none" d="M15 34c2-12 10-20 17-20s15 8 17 20"/><path class="ink-line" fill="none" d="M20 34c0 10 5 18 12 18s12-8 12-18"/><path class="ink-line" fill="none" d="M24 22l-7-6M40 22l7-6"/><path class="ink-line" fill="none" d="M25 40c2 3 4 4 7 4s5-1 7-4"/><circle cx="26" cy="30" r="2" fill="rgba(43,43,53,.75)"/><circle cx="38" cy="30" r="2" fill="rgba(43,43,53,.75)"/></svg>
                </div>
                <div>
                    <h2 class="font-[Fraunces] text-lg">Hi, I‚Äôm Pippin!</h2>
                    <p id="onboardText" class="text-sm text-black/70 leading-snug">Welcome to CozyGram. Let me show you around.</p>
                </div>
            </div>
            <button id="skipOnboarding" class="wobbly rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 px-3 py-2 text-xs font-bold text-black/50">Log In</button>
        </div>
        <div id="authContainer" class="hidden animate-fade-in space-y-3">
            <div class="text-sm font-bold text-center mb-2">Ready to enter your corner?</div>
            <input id="emailInput" type="email" placeholder="you@email.com" class="w-full px-4 py-3 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/80 focus:outline-none focus:ring-2 focus:ring-[#f4a37a]" />
            <button id="magicLinkBtn" class="w-full py-3 rounded-[18px_16px_22px_14px] bg-gradient-to-r from-[#f4a37a] to-[#f7c59f] font-extrabold text-white wobbly shadow-sm">Send Magic Link</button>
            <div id="loginMsg" class="text-center text-xs text-black/50 min-h-[1.5em]"></div>
        </div>
        <div id="onboardNav" class="mt-6 flex items-center justify-between">
            <div id="onboardDots" class="flex items-center gap-2"></div>
            <div class="flex items-center gap-2">
                <button id="onboardBack" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-sm opacity-50" disabled>Back</button>
                <button id="onboardNext" class="wobbly px-4 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-gradient-to-b from-[#f7c59f] to-[#f4a37a] text-sm font-extrabold text-white">Next</button>
            </div>
        </div>
        <div class="mt-4 text-[10px] text-center text-black/40">CozyGram Cloud ‚Ä¢ Creativity over Popularity</div>
    </div>
  </div>

  <div id="app" class="mx-auto w-full max-w-md lg:max-w-none min-h-screen flex flex-col">
    <!-- HEADER -->
    <header class="px-4 pt-5 pb-3">
      <div class="hand-card paper-noise hand-outline px-4 py-3">
        <div class="flex items-center justify-between gap-3">
          
          <!-- NEW LOGO -->
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-[20px] shadow-sm grid place-items-center relative overflow-hidden group wobbly">
                <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none"><defs><linearGradient id="logoWarmth" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#f4a37a" /><stop offset="50%" stop-color="#f7c59f" /><stop offset="100%" stop-color="#dba1a8" /></linearGradient></defs><rect width="100" height="100" fill="url(#logoWarmth)"/><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100" height="100" filter="url(#noise)" opacity="0.15"/></svg>
                <svg class="w-7 h-7 relative z-10" viewBox="0 0 48 48" fill="none" stroke="rgba(43,43,53,0.85)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 18 C8 10 16 8 24 8 C32 8 40 10 40 18 C40 24 36 27 32 29 L24 36 L16 29 C12 27 8 24 8 18 Z" fill="rgba(255,255,255,0.25)"/><path d="M16 18 C16 18 20 21 24 21 C28 21 32 18 32 18"/><path d="M34 10 L35 12 L37 13 L35 14 L34 16 L33 14 L31 13 L33 12 Z" fill="white" stroke="none"/></svg>
            </div>
            <div>
                <div class="flex items-baseline gap-2">
                <h1 class="font-[Fraunces] text-2xl tracking-tight text-[#2b2b35] drop-shadow-sm">CozyGram</h1>
                <span id="backendPill" class="px-1.5 py-0.5 rounded-md bg-white/50 border border-black/5 text-[10px] font-bold text-black/40 uppercase tracking-wider">Cloud</span>
                </div>
                <p class="text-xs text-black/60 leading-tight font-medium">Creativity over popularity</p>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button id="kindToggle" class="wobbly inline-flex items-center gap-2 px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70" aria-pressed="true" title="Kindness mode">
              <span class="text-xs font-semibold">Kind</span>
              <span id="kindPetal" class="inline-block w-5 h-5"><svg viewBox="0 0 48 48" aria-hidden="true"><path d="M24 11c4-6 13-3 12 5-1 10-12 15-12 15S13 26 12 16c-1-8 8-11 12-5Z" fill="rgba(219,161,168,.55)" stroke="rgba(43,43,53,.55)" stroke-width="2" stroke-linejoin="round"/></svg></span>
            </button>
            <button id="openSearch" class="wobbly inline-flex items-center justify-center w-10 h-10 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70" aria-label="Search"><svg class="w-5 h-5" viewBox="0 0 24 24" aria-hidden="true"><circle class="ink-line-lite" cx="11" cy="11" r="6" fill="none"></circle><path class="ink-line-lite" d="M16 16l5 5" fill="none"></path></svg></button>
            <button id="openAccount" class="wobbly inline-flex items-center justify-center w-10 h-10 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70" aria-label="Account"><svg class="w-5 h-5" viewBox="0 0 24 24" aria-hidden="true"><path class="ink-line-lite" d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" fill="rgba(134,166,139,.22)"></path><path class="ink-line-lite" d="M4 22c1.5-5 6-7 8-7s6.5 2 8 7" fill="none"></path></svg></button>
            <button id="logoutBtn" class="wobbly inline-flex items-center justify-center w-10 h-10 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 hidden" aria-label="Log out"><svg class="w-5 h-5" viewBox="0 0 24 24"><path class="ink-line-lite" d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline class="ink-line-lite" points="16 17 21 12 16 7"/><line class="ink-line-lite" x1="21" y1="12" x2="9" y2="12"/></svg></button>
          </div>
        </div>
        <div class="mt-3 flex flex-col sm:flex-row sm:items-center gap-2">
          <div class="flex-1 relative">
            <input id="searchInput" class="w-full px-4 py-3 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/80 focus:outline-none focus:ring-2 focus:ring-black/10" placeholder="Search cozy corners..." />
            <div class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-xs text-black/40">Cmd K</div>
          </div>
          <button id="openSafety" class="wobbly px-3 py-3 rounded-[18px_16px_22px_14px] border border-black/10 bg-gradient-to-b from-white/80 to-white/65" aria-label="Safety"><svg class="w-5 h-5" viewBox="0 0 24 24"><path class="ink-line-lite" d="M12 2l8 4v6c0 6-4 9-8 10C8 21 4 18 4 12V6l8-4Z" fill="rgba(134,166,139,.22)"/><path class="ink-line-lite" d="M9 12l2 2 4-5" fill="none"/></svg></button>
        </div>
      </div>
    </header>

    <main id="main" class="flex-1 px-4 main-safe-pad">
      <!-- FEED -->
      <!-- FEED SECTION -->
      <section id="view-feed" class="space-y-4">
        
        <!-- 1. DAILY CHECKIN -->
        <div id="dailyCheckin" class="hand-card hand-outline paper-noise p-4">
          <div class="flex items-start justify-between gap-3">
            <div><div class="font-[Fraunces] text-lg">Daily gentle check‚Äëin</div><div class="text-sm text-black/70 mt-1">Private to this device.</div></div>
            <button id="clearCheckin" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold">Clear</button>
          </div>
          <div class="mt-3 flex flex-wrap gap-2">
            <button class="moodPick wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70" data-mood="calm"><span class="text-xs font-extrabold">Calm üåø</span></button>
            <button class="moodPick wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70" data-mood="bright"><span class="text-xs font-extrabold">Bright ‚ú®</span></button>
            <button class="moodPick wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70" data-mood="tired"><span class="text-xs font-extrabold">Tired ‚òÅÔ∏è</span></button>
          </div>
        </div>

        <!-- 2. LOW PRESSURE BANNER (Moved from JS to HTML) -->
        <div class="hand-card hand-outline paper-noise p-4">
          <div class="flex items-start gap-3">
            <div class="w-12 h-12 rounded-[20px] shadow-sm grid place-items-center relative overflow-hidden group wobbly">
                <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none"><defs><linearGradient id="logoWarmth" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#f4a37a" /><stop offset="50%" stop-color="#f7c59f" /><stop offset="100%" stop-color="#dba1a8" /></linearGradient></defs><rect width="100" height="100" fill="url(#logoWarmth)"/><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100" height="100" filter="url(#noise)" opacity="0.15"/></svg>
                <svg class="w-7 h-7 relative z-10" viewBox="0 0 48 48" fill="none" stroke="rgba(43,43,53,0.85)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 18 C8 10 16 8 24 8 C32 8 40 10 40 18 C40 24 36 27 32 29 L24 36 L16 29 C12 27 8 24 8 18 Z" fill="rgba(255,255,255,0.25)"/><path d="M16 18 C16 18 20 21 24 21 C28 21 32 18 32 18"/><path d="M34 10 L35 12 L37 13 L35 14 L34 16 L33 14 L31 13 L33 12 Z" fill="white" stroke="none"/></svg>
            </div>
            <div class="min-w-0 flex-1">
              <div class="font-[Fraunces] text-lg">A low-pressure feed</div>
              <div class="text-sm text-black/70 mt-1">No public likes. No follower counts. Just gentle notes + stickers.</div>
              <div class="mt-3 flex flex-wrap gap-2">
                <button id="shuffleFeedBtn" onclick="toast('Shuffled cozy order.')" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-sm font-extrabold">Shuffle cozy</button>
                <button id="meetPippinBtn" onclick="$('#onboardingModal').classList.remove('hidden'); state.onboardingStep=0; renderOnboarding();" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-sm">Meet Pippin</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 3. FILTERS -->
        <div id="userFilterBanner" class="hand-card hand-outline bg-white/70 border border-black/10 p-4 hidden">
            <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-3"><div class="text-sm font-extrabold">Filtering by User</div></div>
                <button onclick="clearUserFilter()" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold">Clear</button>
            </div>
        </div>
        <div class="flex flex-wrap gap-2">
             <button class="topicBtn wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold" data-t="all">All</button>
             <button class="topicBtn wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold" data-t="art">Art</button>
             <button class="topicBtn wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold" data-t="selfcare">Self-care</button>
             <button class="topicBtn wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold" data-t="friends">Friends</button>
        </div>

        <!-- 4. NEW POST BUTTON (Moved Here) -->
        <button id="newPostTrigger" class="w-full text-left hand-card hand-outline bg-gradient-to-r from-white/80 to-[#fffaf1] border border-black/10 p-3 wobbly flex items-center gap-4 group">
           <div class="w-10 h-10 rounded-[14px] bg-[#f4a37a]/15 border border-[#f4a37a]/20 grid place-items-center text-xl group-hover:scale-110 transition-transform">
             ‚ú®
           </div>
           <div>
             <div class="text-sm font-extrabold text-black/80">Make a cozy post</div>
             <div class="text-xs text-black/50">Share a moment, a doodle, or a thought...</div>
           </div>
        </button>

        <!-- 5. FEED CONTENT -->
        <div id="feed-container" class="space-y-4">
            <div class="p-6 text-center animate-pulse text-black/50 font-[Fraunces]">Connecting to the clouds...</div>
        </div>
      </section>

      <!-- STORIES -->
      <section id="view-stories" class="hidden space-y-4">
          <div class="hand-card hand-outline paper-noise p-4">
            <div class="flex items-start justify-between gap-3">
              <div><h2 class="font-[Fraunces] text-lg">Stories, but as journal pages</h2><p class="text-sm text-black/70 mt-1">Flip through pages. Respond with a sticker.</p></div>
              <button onclick="openStoryComposeModal()" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold">New page</button>
            </div>
          </div>
          <div id="clubsContainer" class="hand-card hand-outline bg-white/70 border border-black/10 p-4"></div>
          <div id="storiesList" class="space-y-3"></div>
          <div class="hand-card hand-outline bg-white/70 border border-black/10 p-4">
            <div class="flex items-center justify-between mb-3"><div class="text-sm font-extrabold">Gentle prompts</div><button class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold" onclick="pickRandomPrompt()">Surprise me</button></div>
            <div id="promptsGrid" class="grid grid-cols-2 gap-3"></div>
          </div>
      </section>
      
      <!-- MESSAGES -->
      <section id="view-messages" class="hidden space-y-4">
          <div class="hand-card hand-outline paper-noise p-4">
            <div class="flex items-start justify-between gap-3">
                <div><h2 class="font-[Fraunces] text-lg">Passing Notes</h2><p class="text-sm text-black/70 mt-1">Chats feel like folded paper.</p></div>
                <button onclick="$('#newThreadModal').classList.remove('hidden')" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold">New note</button>
            </div>
          </div>
          <div class="desktop-two-col">
              <div id="threadList" class="space-y-2"></div>
              <div class="hand-card hand-outline bg-white/70 border border-black/10 p-3 flex flex-col h-[500px]">
                  <div id="chatHeader" class="flex items-center justify-between border-b border-black/5 pb-2 mb-2"><div class="font-extrabold text-sm opacity-50">Select a note to read</div></div>
                  <div id="chatMessages" class="flex-1 overflow-y-auto space-y-2 p-1 mb-2"></div>
                  <div id="chatInputArea" class="hidden">
                      <div class="flex flex-wrap gap-2 mb-2">
                          <button class="quickReply text-[10px] px-2 py-1 bg-white border rounded-[8px] wobbly" onclick="$('#chatInput').value='Sending a warm hug ü§ó'; $('#chatInput').focus();">Warm hug</button>
                          <button class="quickReply text-[10px] px-2 py-1 bg-white border rounded-[8px] wobbly" onclick="$('#chatInput').value='Thinking of you üåø'; $('#chatInput').focus();">Thinking of you</button>
                      </div>
                      <div class="flex gap-2">
                          <input id="chatInput" class="flex-1 px-3 py-2 rounded-[12px] border border-black/10 text-sm focus:outline-none" placeholder="Write a gentle note..." />
                          <button id="chatSendBtn" class="px-3 py-2 bg-[#f4a37a] text-white font-bold rounded-[12px] wobbly text-xs">Send</button>
                      </div>
                      <div id="kindHint" class="mt-2 text-xs text-black/55 hidden">Tip: ‚ÄúDo you want comfort or solutions?‚Äù helps a lot.</div>
                  </div>
              </div>
          </div>
      </section>
      
      <!-- NOTIFICATIONS -->
      <section id="view-notifs" class="hidden space-y-4">
          <div class="hand-card hand-outline paper-noise p-4">
              <h2 class="font-[Fraunces] text-lg">Lantern Glow</h2>
              <p class="text-sm text-black/70 mt-1">Updates that feel warm.</p>
          </div>
          <div class="flex justify-between items-center px-1"><div class="text-xs text-black/50">Recent glows</div><button class="text-xs font-bold opacity-50 hover:opacity-100" onclick="document.getElementById('notifList').innerHTML = ''; toast('Cleared.')">Clear all</button></div>
          <div id="notifList" class="space-y-3"></div>
      </section>
      
      <!-- PROFILE -->
      <section id="view-profile" class="hidden space-y-4"></section>
    </main>

    <!-- FAB -->
    <button id="fab" class="fixed left-1/2 -translate-x-1/2 fab-safe wobbly hand-card hand-outline paper-noise px-4 py-3 flex items-center gap-3 z-20">
      <span class="inline-block w-10 h-10 rounded-[18px_16px_22px_14px] bg-gradient-to-br from-[#f4a37a] via-[#fbf5ea] to-[#dba1a8] border border-black/10 grid place-items-center text-xl font-bold text-black/70">+</span>
      <div class="text-left"><div class="text-sm font-extrabold">New cozy post</div><div class="text-xs text-black/55">Frame + a little note</div></div>
    </button>

    <!-- BOTTOM NAV -->
    <nav id="bottomNav" class="fixed left-1/2 -translate-x-1/2 nav-safe w-[min(420px,calc(100%-2rem))] nav-pill px-3 py-3 z-30">
      <div class="navGrid grid grid-cols-5 gap-2">
        <button class="navBtn wobbly" data-tab="feed" aria-label="Home feed"><div class="navItem" id="nav-feed"></div></button>
        <button class="navBtn wobbly" data-tab="stories" aria-label="Stories journal"><div class="navItem" id="nav-stories"></div></button>
        <button class="navBtn wobbly" data-tab="messages" aria-label="Messages mailbox"><div class="navItem" id="nav-messages"></div></button>
        <button class="navBtn wobbly" data-tab="notifs" aria-label="Notifications lantern"><div class="navItem" id="nav-notifs"></div></button>
        <button class="navBtn wobbly" data-tab="profile" aria-label="Profile scrapbook"><div class="navItem" id="nav-profile"></div></button>
      </div>
    </nav>
  </div>

  <!-- ALL MODALS -->
  <div id="userModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/20 backdrop-blur-[2px] hidden p-4 modal-safe" data-overlay>
      <div class="w-full max-w-md hand-card hand-outline paper-noise p-4 pop-in modal-card" role="dialog">
        <div class="flex justify-between items-center mb-4"><h3 class="font-[Fraunces] text-lg">Cozy Corner</h3><button onclick="$('#userModal').classList.add('hidden')" class="text-xs font-bold opacity-50">Close</button></div>
        <div id="userModalBody"></div>
      </div>
  </div>
  <div id="newThreadModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/20 backdrop-blur-[2px] hidden p-4 modal-safe" data-overlay>
      <div class="w-full max-w-md hand-card hand-outline paper-noise p-4 pop-in modal-card" role="dialog">
        <div class="flex justify-between items-center mb-4"><h3 class="font-[Fraunces] text-lg">New Note</h3><button onclick="$('#newThreadModal').classList.add('hidden')" class="text-xs font-bold opacity-50">Close</button></div>
        <div id="userList" class="space-y-2"></div>
      </div>
  </div>
  <div id="accountModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/20 backdrop-blur-[2px] hidden p-4 modal-safe" data-overlay>
      <div class="w-full max-w-md hand-card hand-outline paper-noise p-4 pop-in modal-card" role="dialog">
        <div class="flex justify-between items-center mb-4"><h3 class="font-[Fraunces] text-lg">Account</h3><button onclick="$('#accountModal').classList.add('hidden')" class="text-xs font-bold opacity-50">Close</button></div>
        <div id="accountBody" class="space-y-2"></div>
      </div>
  </div>
  <div id="safetyModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/20 backdrop-blur-[2px] hidden p-4 modal-safe" data-overlay>
      <div class="w-full max-w-md hand-card hand-outline paper-noise p-4 pop-in modal-card" role="dialog">
        <div class="flex items-center justify-between mb-4"><h3 class="font-[Fraunces] text-lg">Safety & comfort</h3><button onclick="$('#safetyModal').classList.add('hidden')" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-sm">Done</button></div>
        <div class="space-y-3 text-sm">
          <div class="hand-card bg-white/70 border border-black/10 p-3 flex justify-between items-start gap-3"><div><div class="font-extrabold">Kindness reminders</div><div class="text-xs text-black/60">Gentle prompts enabled.</div></div><button id="kindToggle2" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/80 text-xs font-bold">On</button></div>
          <div class="hand-card bg-white/70 border border-black/10 p-3 flex justify-between items-start gap-3"><div><div class="font-extrabold">Hide numbers</div><div class="text-xs text-black/60">No public counts.</div></div><button id="numbersToggle" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/80 text-xs font-bold">On</button></div>
          <div class="hand-card bg-white/70 border border-black/10 p-3"><div class="font-extrabold">Cozy guidelines</div><ul class="mt-2 text-xs text-black/65 list-disc pl-5 space-y-1"><li>Assume good intent.</li><li>Use stickers to support, not to score.</li><li>If something feels unsafe, step away.</li></ul></div>
        </div>
      </div>
  </div>
  <div id="storyModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/30 backdrop-blur-[2px] hidden p-4 modal-safe" data-overlay>
    <div class="w-full max-w-md hand-card hand-outline paper-noise p-4 pop-in modal-card" role="dialog">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3"><div id="storyAvatar" class="w-10 h-10 rounded-[18px_16px_22px_14px] border border-black/10 overflow-hidden bg-white"></div><div><div id="storyTitle" class="font-extrabold text-sm"></div><div id="storyMeta" class="text-xs text-black/55"></div></div></div>
        <button onclick="$('#storyModal').classList.add('hidden')" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-sm">Close</button>
      </div>
      <div id="storyPage" class="hand-card hand-outline bg-white/70 border border-black/10 p-5 mb-4 min-h-[200px] flex items-center justify-center text-center font-serif text-lg leading-relaxed text-black/80 flex-col"></div>
      <div class="flex justify-center gap-4 mb-4"><button class="wobbly text-2xl" onclick="toast('Sent a warm hug!')">ü§ó</button><button class="wobbly text-2xl" onclick="toast('Sent a star!')">‚≠ê</button><button class="wobbly text-2xl" onclick="toast('Sent a calm leaf!')">üçÉ</button></div>
      <button id="replyStoryBtn" class="w-full mb-3 py-3 rounded-[18px_16px_22px_14px] border border-black/10 bg-gradient-to-b from-[#86a68b] to-[#6f9b7a] text-white font-extrabold wobbly">Reply with a note</button>
      <div class="flex items-center justify-between"><button id="prevStory" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-sm">Prev</button><button id="nextStory" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-sm">Next</button></div>
    </div>
  </div>
  <div id="composeModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/20 backdrop-blur-[2px] hidden p-4 modal-safe" data-overlay>
    <div class="w-full max-w-md hand-card hand-outline paper-noise bg-white p-4 pop-in modal-card" role="dialog">
        <div class="flex justify-between items-center mb-3"><h3 class="font-[Fraunces] text-lg">Make a cozy post</h3><button id="closeCompose" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-sm">Close</button></div>
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div id="composePreviewContainer" class="bg-gray-50 rounded-[18px_16px_22px_14px] border border-black/10 flex items-center justify-center aspect-[4/3] overflow-hidden relative"><div id="composePreview" class="w-full h-full"></div><input type="file" id="mediaInput" accept="image/*,video/*" class="absolute inset-0 opacity-0 cursor-pointer" /><div class="absolute bottom-2 right-2 bg-white/80 px-2 py-1 rounded text-[10px] pointer-events-none font-bold">Tap to upload</div></div>
            <div class="space-y-2">
                <div class="text-[10px] uppercase font-bold opacity-50">Frame</div>
                <div class="flex gap-2 flex-wrap"><button class="frameBtn px-2 py-1 bg-white border rounded-[10px] wobbly text-xs" data-f="wavy">Wavy</button><button class="frameBtn px-2 py-1 bg-white border rounded-[10px] wobbly text-xs" data-f="polaroid">Polar</button><button class="frameBtn px-2 py-1 bg-white border rounded-[10px] wobbly text-xs" data-f="tape">Tape</button></div>
                <div class="text-[10px] uppercase font-bold opacity-50">Vibe</div>
                <div class="flex gap-1 flex-wrap"><button class="vibeBtn w-6 h-6 rounded-full border wobbly" style="background:#f4a37a" data-v="sunset"></button><button class="vibeBtn w-6 h-6 rounded-full border wobbly" style="background:#86a68b" data-v="sage"></button><button class="vibeBtn w-6 h-6 rounded-full border wobbly" style="background:#dba1a8" data-v="berry"></button><button class="vibeBtn w-6 h-6 rounded-full border wobbly" style="background:#b87d66" data-v="clay"></button></div>
                <div class="text-[10px] uppercase font-bold opacity-50">Illustration</div><div id="artPicker" class="flex gap-2 flex-wrap mt-1"></div>
            </div>
        </div>
        <textarea id="composeCaption" class="w-full px-4 py-3 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/80 focus:outline-none focus:ring-2 focus:ring-black/10 h-24 text-sm" placeholder="What made today soft?"></textarea>
        <div id="composeTags" class="flex gap-2 mt-2 mb-2"></div>
        <button id="postNowBtn" class="w-full mt-3 py-3 rounded-[18px_16px_22px_14px] bg-gradient-to-b from-[#86a68b] to-[#6f9b7a] text-white font-extrabold wobbly">Post to Cloud</button>
    </div>
  </div>
  <div id="storyComposeModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/20 backdrop-blur-[2px] hidden p-4 modal-safe" data-overlay>
    <div class="w-full max-w-md hand-card hand-outline paper-noise bg-white p-4 pop-in modal-card" role="dialog">
        <div class="flex justify-between items-center mb-3"><h3 class="font-[Fraunces] text-lg">New Page</h3><button onclick="$('#storyComposeModal').classList.add('hidden')" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-sm">Close</button></div>
        <input id="storyHeading" class="w-full px-4 py-3 mb-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/80 focus:outline-none focus:ring-2 focus:ring-black/10 text-sm" placeholder="Title (e.g. Morning thoughts)" />
        <textarea id="storyText" class="w-full px-4 py-3 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/80 focus:outline-none focus:ring-2 focus:ring-black/10 h-32 text-sm font-serif leading-relaxed" placeholder="Dear journal..."></textarea>
        <button onclick="saveStoryPage()" class="w-full mt-3 py-3 rounded-[18px_16px_22px_14px] bg-gradient-to-b from-[#86a68b] to-[#6f9b7a] text-white font-extrabold wobbly">Publish Page</button>
    </div>
  </div>
  <div id="roomModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/20 backdrop-blur-[2px] hidden p-4 modal-safe" data-overlay>
      <div class="w-full max-w-lg hand-card hand-outline paper-noise p-4 pop-in modal-card" role="dialog">
        <div class="flex justify-between items-center mb-4"><h3 class="font-[Fraunces] text-lg" id="roomTitle">Your Room</h3><button onclick="$('#roomModal').classList.add('hidden')" class="text-xs font-bold opacity-50">Close</button></div>
        <div id="roomBody" class="space-y-4"></div>
      </div>
  </div>
  <div id="postOptionsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-[2px] hidden p-4 modal-safe" data-overlay>
    <div class="w-full max-w-xs hand-card hand-outline paper-noise bg-white p-4 pop-in" role="dialog">
        <h3 class="font-bold mb-3 text-center">Options</h3>
        <button id="savePostBtn" class="w-full py-3 mb-2 rounded-[18px_16px_22px_14px] border border-black/10 font-bold wobbly">Save to Drawer</button>
        <button id="sharePostBtn" class="w-full py-3 mb-2 rounded-[18px_16px_22px_14px] bg-gradient-to-b from-[#f7c59f] to-[#f4a37a] text-white font-extrabold wobbly">Share Post</button>
        <button id="hidePostBtn" class="w-full py-3 mb-2 rounded-[18px_16px_22px_14px] border border-black/10 font-bold wobbly">Hide Post</button>
        <button id="muteUserBtn" class="w-full py-3 mb-2 rounded-[18px_16px_22px_14px] border border-black/10 font-bold wobbly">Mute User</button>
        <button id="copyCaptionBtn" class="w-full py-3 mb-2 rounded-[18px_16px_22px_14px] border border-black/10 font-bold wobbly">Copy Caption</button>
        <button id="deletePostBtn" class="w-full py-3 mb-2 rounded-[18px_16px_22px_14px] bg-red-100 text-red-600 font-bold wobbly hidden">Delete Post</button>
        <button id="reportPostBtn" class="w-full py-3 mb-2 rounded-[18px_16px_22px_14px] border border-black/10 font-bold wobbly">Report</button>
        <button onclick="$('#postOptionsModal').classList.add('hidden')" class="w-full py-3 rounded-[18px_16px_22px_14px] border border-black/10 text-black/50 wobbly">Cancel</button>
    </div>
  </div>
  <div id="editProfileModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-[2px] hidden p-4" data-overlay>
    <div class="w-full max-w-md hand-card hand-outline paper-noise bg-white p-4 pop-in modal-card" role="dialog">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-[Fraunces] text-lg">Edit Corner</h3>
            <button onclick="$('#editProfileModal').classList.add('hidden')" class="text-sm">Cancel</button>
        </div>
        
        <!-- NEW: Avatar Picker Inside Modal -->
        <div class="flex justify-center mb-4">
            <div class="relative group cursor-pointer wobbly" onclick="document.getElementById('avatarFileInput').click()">
                <div id="editProfileAvatarPreview" class="w-20 h-20 rounded-[24px_20px_26px_18px] border border-black/10 overflow-hidden bg-gray-100">
                    <!-- Avatar injected via JS -->
                </div>
                <div class="absolute inset-0 bg-black/20 flex items-center justify-center rounded-[24px_20px_26px_18px] opacity-0 group-hover:opacity-100 transition-opacity">
                    <span class="text-xs font-bold text-white bg-black/50 px-2 py-1 rounded">Change</span>
                </div>
                <div class="absolute -bottom-1 -right-1 bg-white border border-black/10 rounded-full p-1 shadow-sm pointer-events-none">
                    <svg class="w-3 h-3" viewBox="0 0 24 24"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </div>
            </div>
        </div>

        <input id="setupName" class="w-full mb-2 px-4 py-3 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/80" placeholder="Name" />
        <input id="setupPronouns" class="w-full mb-2 px-4 py-3 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/80" placeholder="Pronouns" />
        <textarea id="setupBio" class="w-full mb-3 px-4 py-3 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/80 h-24" placeholder="Bio..."></textarea>
        
        <div class="mt-2 text-xs font-bold opacity-50">Mood Lighting</div>
        <div class="flex gap-2 mb-4 mt-1">
          <button class="setupMood wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold" data-m="sunset">Sunset</button>
          <button class="setupMood wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold" data-m="sage">Sage</button>
          <button class="setupMood wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold" data-m="berry">Berry</button>
          <button class="setupMood wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold" data-m="clay">Clay</button>
        </div>
        <button id="saveProfileSetup" class="w-full py-3 rounded-[18px_16px_22px_14px] bg-[#f4a37a] text-white font-bold wobbly">Save</button>
    </div>
  </div>
  <div id="commentsModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/20 backdrop-blur-[2px] hidden p-4 modal-safe" data-overlay>
    <div class="w-full max-w-md hand-card hand-outline paper-noise bg-white p-4 pop-in modal-card" role="dialog">
        <div class="flex justify-between items-center mb-3"><h3 class="font-[Fraunces] text-lg">Supportive Notes</h3><button onclick="$('#commentsModal').classList.add('hidden')" class="text-sm font-bold opacity-50">Close</button></div>
        <div id="commentsList" class="space-y-2 mb-4 text-sm text-black/70"></div>
        <textarea id="commentInput" class="w-full p-3 rounded-[18px_16px_22px_14px] border border-black/10 bg-white focus:outline-none h-20 text-lg font-hand" placeholder="Leave a kind note..."></textarea>
        <button id="sendCommentBtn" class="w-full mt-2 py-2 rounded-[18px_16px_22px_14px] bg-[#f4a37a] text-white font-bold wobbly">Send</button>
    </div>
  </div>
  <div id="textModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/20 backdrop-blur-[2px] hidden p-4 modal-safe" data-overlay>
      <div class="w-full max-w-lg hand-card hand-outline paper-noise p-4 pop-in modal-card" role="dialog">
          <div class="flex items-start justify-between gap-3 mb-3"><div><div id="textModalTitle" class="font-[Fraunces] text-lg">Write</div><div id="textModalSubtitle" class="text-xs text-black/60">Gentle + short is perfect.</div></div><button onclick="closeTextModal()" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-sm">Close</button></div>
          <div class="mt-3">
              <textarea id="textModalInput" class="w-full min-h-[140px] px-4 py-3 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/80 focus:outline-none focus:ring-2 focus:ring-black/10" placeholder=""></textarea>
              <div class="mt-2 flex items-center justify-between gap-2"><div id="textModalHint" class="text-xs text-black/55">Tip: be specific and kind.</div><div class="text-xs text-black/45"><span id="textModalCount">0</span>/<span id="textModalMax">220</span></div></div>
          </div>
          <div class="mt-3 flex items-center justify-between gap-2"><button onclick="closeTextModal()" class="wobbly px-4 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-sm font-extrabold">Cancel</button><button id="textModalSave" class="wobbly px-4 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-gradient-to-b from-[#86a68b] to-[#6f9b7a] text-white text-sm font-extrabold">Save</button></div>
      </div>
  </div>
  <div id="toast" class="fixed bottom-32 left-1/2 -translate-x-1/2 bg-white border border-black/10 px-4 py-2 rounded-[18px_16px_22px_14px] shadow-lg text-sm font-bold hidden z-50 pop-in"><div></div></div> 
   <!-- Hidden File Input for Avatars -->
 <input id="avatarFileInput" type="file" accept="image/*" class="hidden" />

  <script>
    const SUPABASE_URL = 'https://dcarzattebyvkojqflyb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjYXJ6YXR0ZWJ5dmtvanFmbHliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NTQxMTUsImV4cCI6MjA4MTEzMDExNX0.zc4LjPWrfS8OkRzN59h9YM8VFQE2JTZiRgWktPFJGHI'; 
    let sb;
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const html = s => (s||'').replace(/&/g, "&amp;").replace(/</g, "&lt;");
    const toast = (msg) => {
      const t = $('#toast');
      const box = $('#toast > div');
      box.innerText = msg;
      t.classList.remove('hidden');
      t.classList.remove('pop-in'); 
      void t.offsetWidth; 
      t.classList.add('pop-in');
      clearTimeout(toast._t);
      toast._t = setTimeout(() => { t.classList.add('hidden'); }, 3000);
    };
    function safeCopy(text){
      const t = String(text ?? '');
      if(navigator.clipboard?.writeText) return navigator.clipboard.writeText(t).then(()=>true).catch(()=>false);
      return false; 
    }
    function timeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + "y";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + "mo";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + "d";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + "h";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + "m";
        return "now";
    }

    // --- MISSING HELPERS (Paste this after timeAgo) ---

    // 1. Array of illustration choices for the composer
    const illustChoices = [
      { id: 'surprise', label: 'Surprise', seed: null },
      { id: 'sunny', label: 'Sunny', seed: 11 },
      { id: 'cloud', label: 'Cloud', seed: 22 },
      { id: 'garden', label: 'Garden', seed: 33 },
      { id: 'cozy', label: 'Cozy', seed: 44 },
      { id: 'moon', label: 'Moon', seed: 55 },
      { id: 'spark', label: 'Spark', seed: 66 },
      { id: 'picnic', label: 'Picnic', seed: 77 }
    ];

    // 2. Function to generate the abstract art SVGs
    function artSVG(seed=1, palette='sunset'){
      const palettes = { 
        sunset: ['#f4a37a','#f7c59f','#fbf5ea','#dba1a8'], 
        sage: ['#86a68b','#b7cbb7','#fbf5ea','#f7c59f'], 
        berry: ['#dba1a8','#c77d93','#fbf5ea','#6f6a86'], 
        clay: ['#b87d66','#f4a37a','#fbf5ea','#86a68b'] 
      };
      
      const [a,b,c,d] = palettes[palette] || palettes.sunset;
      
      // Generate random-looking blobs based on the seed
      const blobs = Array.from({length: 7}, (_,i)=>{ 
        const x = 10 + ((seed*37 + i*11) % 80); 
        const y = 10 + ((seed*23 + i*17) % 80); 
        const r = 9 + ((seed*19 + i*7) % 20); 
        const col = [a,b,d,c][i%4]; 
        const op = 0.30 + ((seed+i)%4)*0.06; 
        return `<circle cx="${x}" cy="${y}" r="${r}" fill="${col}" opacity="${op}" />`; 
      }).join('');
      
      const doodle = `<path d="M20 70c10-18 30-18 40 0" fill="none" stroke="rgba(43,43,53,.33)" stroke-width="3" stroke-linecap="round"/><path d="M26 52c6 4 14 4 20 0" fill="none" stroke="rgba(43,43,53,.30)" stroke-width="3" stroke-linecap="round"/><path d="M54 30c6 6 6 18 0 24" fill="none" stroke="rgba(43,43,53,.26)" stroke-width="3" stroke-linecap="round"/><path d="M10 36c4-6 10-6 14 0" fill="none" stroke="rgba(43,43,53,.23)" stroke-width="3" stroke-linecap="round"/>`;
      const gradId = `g${seed}${palette}`;
      
      return `<svg viewBox="0 0 100 100" class="w-full h-full"><defs><linearGradient id="${gradId}" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="${a}" stop-opacity=".76"/><stop offset=".55" stop-color="${b}" stop-opacity=".64"/><stop offset="1" stop-color="${c}" stop-opacity=".92"/></linearGradient></defs><rect x="0" y="0" width="100" height="100" rx="18" fill="url(#${gradId})" />${blobs}<g opacity=".95">${doodle}</g><g opacity=".33"><path d="M14 18c10 2 14-3 22-6" fill="none" stroke="rgba(255,255,255,.65)" stroke-width="5" stroke-linecap="round"/></g></svg>`;
    }

    // 3. (Just in case you missed it earlier) Apply Mood Function
    function applyMood(moodId){
      const themes = {
        sunset: { a:'rgba(247,197,159,.55)', b:'rgba(134,166,139,.35)', c:'rgba(219,161,168,.22)', bg1:'#fff5ea', bg2:'#fbf5ea', bg3:'#f7f0e6' },
        sage:   { a:'rgba(134,166,139,.45)', b:'rgba(247,197,159,.25)', c:'rgba(111,106,134,.18)', bg1:'#f6fff8', bg2:'#fbf5ea', bg3:'#f3f6f2' },
        berry:  { a:'rgba(219,161,168,.42)', b:'rgba(247,197,159,.22)', c:'rgba(111,106,134,.22)', bg1:'#fff3f6', bg2:'#fbf5ea', bg3:'#f7f0f2' },
        clay:   { a:'rgba(184,125,102,.40)', b:'rgba(247,197,159,.28)', c:'rgba(134,166,139,.18)', bg1:'#fff7f1', bg2:'#fbf5ea', bg3:'#f6efe7' }
      };
      const m = themes[moodId] || themes.sunset;
      const r = document.documentElement.style;
      r.setProperty('--mood-a', m.a); r.setProperty('--mood-b', m.b); r.setProperty('--mood-c', m.c);
      r.setProperty('--mood-bg1', m.bg1); r.setProperty('--mood-bg2', m.bg2); r.setProperty('--mood-bg3', m.bg3);
    }

    // --- MEDIA COMPRESSION HELPER ---
    async function compressImageToBlob(file, maxDim=1600, quality=0.86){
      // If it's a video or not an image, return original
      if (!file || !file.type.startsWith('image/')) return file;
      
      const imgUrl = URL.createObjectURL(file);
      try{
        const img = await new Promise((resolve, reject)=>{
          const i = new Image();
          i.onload = ()=> resolve(i);
          i.onerror = ()=> reject(new Error('Image load failed'));
          i.src = imgUrl;
        });

        // Calculate new dimensions (max 1600px)
        const w = img.naturalWidth || img.width;
        const h = img.naturalHeight || img.height;
        const scale = Math.min(1, maxDim / Math.max(w, h));
        const cw = Math.max(1, Math.round(w * scale));
        const ch = Math.max(1, Math.round(h * scale));

        // Draw to canvas
        const canvas = document.createElement('canvas');
        canvas.width = cw; canvas.height = ch;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#fff';
        ctx.fillRect(0,0,cw,ch); // Fill transparent backgrounds (PNG) with white
        ctx.drawImage(img, 0,0,cw,ch);

        // Convert back to file/blob
        const mime = (file.type === 'image/png') ? 'image/png' : 'image/jpeg';
        const blob = await new Promise(resolve=> canvas.toBlob(resolve, mime, quality));
        return blob || file;
      } catch(e) {
        console.error("Compression failed, using original", e);
        return file;
      } finally {
        try{ URL.revokeObjectURL(imgUrl); }catch{}
      }
    }

    const state = { 
        user: null, profile: null, posts: [], savedPostIds: [], stories: [],
        allUsers: [], notifications: [], threads: [],
        compose: { 
            frame: 'wavy', 
            vibe: 'sunset', 
            file: null, 
            mediaKind: null,      // 'image' or 'video'
            mediaPreviewUrl: null, // The blob:url for the preview
            seed: Math.floor(Math.random()*100), 
            illustSeed: null 
        },
        filter: { search: '', topic: 'all' },
        kindness: true, hideNumbers: true,
        hiddenPosts: [], // DB-backed
        mutedUsers: [], // DB-backed
        savedPrompts: [], // DB-backed (Shelf)
        lastRead: JSON.parse(localStorage.getItem('cozy_last_read') || '{}'),
        habits: JSON.parse(localStorage.getItem('dailyHabits') || '{}'),
        activePostOption: null, activePostUser: null,
        storyIndex: 0, storyPageIndex: 0, activeThreadId: null,
        onboardingStep: 0, onboarded: false,
        textModal: { onSave: null, max: 220 },
        tab: 'feed',
        comments: { postId: null }
    };

    // --- MISSING CONSTANTS (Paste this after 'const state') ---

    const STICKER_SVGS = {
      hug: `<svg viewBox="0 0 48 48" class="w-6 h-6"><path d="M24 12c6-7 16-2 14 7-2 9-14 18-14 18S12 28 10 19c-2-9 8-14 14-7Z" fill="rgba(244,163,122,.45)" stroke="rgba(43,43,53,.55)" stroke-width="2" stroke-linejoin="round"/><path d="M17 23c2 2 4 3 7 3s5-1 7-3" fill="none" stroke="rgba(43,43,53,.45)" stroke-width="2" stroke-linecap="round"/></svg>`,
      star: `<svg viewBox="0 0 48 48" class="w-6 h-6"><path d="M24 9l4 10 11 1-8 7 2 11-9-6-9 6 2-11-8-7 11-1 4-10Z" fill="rgba(247,197,159,.55)" stroke="rgba(43,43,53,.55)" stroke-width="2" stroke-linejoin="round"/></svg>`,
      leaf: `<svg viewBox="0 0 48 48" class="w-6 h-6"><path d="M12 30c10-18 20-18 24-18 0 6-2 24-20 26-5 1-6-4-4-8Z" fill="rgba(134,166,139,.5)" stroke="rgba(43,43,53,.55)" stroke-width="2" stroke-linejoin="round"/><path d="M18 31c6-6 12-10 18-12" fill="none" stroke="rgba(43,43,53,.45)" stroke-width="2" stroke-linecap="round"/></svg>`,
      spark: `<svg viewBox="0 0 48 48" class="w-6 h-6"><path d="M24 10l3 8 8 3-8 3-3 8-3-8-8-3 8-3 3-8Z" fill="rgba(219,161,168,.55)" stroke="rgba(43,43,53,.55)" stroke-width="2" stroke-linejoin="round"/></svg>`,
      cocoa: `<svg viewBox="0 0 48 48" class="w-6 h-6"><path d="M16 18h16v14a6 6 0 0 1-6 6h-4a6 6 0 0 1-6-6V18Z" fill="rgba(247,197,159,.35)" stroke="rgba(43,43,53,.55)" stroke-width="2" stroke-linejoin="round"/><path d="M32 20h4a4 4 0 0 1 0 8h-4" fill="none" stroke="rgba(43,43,53,.35)" stroke-width="2" stroke-linecap="round"/></svg>`
    };

    const MOCK_CLUBS = [
        { id:'study', title:'Study Nook', desc:'Quiet encouragement', tag:'school' }, 
        { id:'art', title:'Doodle Picnic', desc:'Messy sketches welcome', tag:'art' }, 
        { id:'music', title:'Playlist Exch', desc:'Warm songs only', tag:'music' }, 
        { id:'books', title:'Reading Corner', desc:'No spoilers, just vibes', tag:'selfcare' }
    ];

    const MOCK_PROMPTS = [
        { title:'What color did you see?', desc:'One sentence post.' }, 
        { title:'Show your desk corner', desc:'No faces needed.' }, 
        { title:'One kind thing you did', desc:'Small counts.' }, 
        { title:'A comfort snack', desc:'Name it like a spell.' }
    ];

    // --- HELPER FUNCTIONS ---
    
    function inferTags(text) {
        if (!text) return [];
        const tags = (text.match(/#[\w-]+/g) || []).map(t => t.slice(1));
        const lower = text.toLowerCase();
        if (lower.includes('art') && !tags.includes('art')) tags.push('art');
        if (lower.includes('friend') && !tags.includes('friends')) tags.push('friends');
        if (lower.includes('self') && !tags.includes('selfcare')) tags.push('selfcare');
        return tags;
    }

    // --- CLEAN HELPER FUNCTIONS ---
    
    function avatarHTML(u) {
        // If user has a custom photo, show it
        if (u && u.avatar_url) {
            return `<img src="${u.avatar_url}" class="w-full h-full object-cover" alt="${u.username}'s avatar" />`;
        }
        // Fallback to the generated art
        return avatarSVG(u?.seed || 1);
    }
    
    function avatarSVG(seed=1){
      const bg = ['linear-gradient(135deg, rgba(247,197,159,.95), rgba(251,245,234,.85))','linear-gradient(135deg, rgba(134,166,139,.75), rgba(251,245,234,.9))','linear-gradient(135deg, rgba(219,161,168,.8), rgba(251,245,234,.9))','linear-gradient(135deg, rgba(111,106,134,.55), rgba(251,245,234,.9))','linear-gradient(135deg, rgba(184,125,102,.65), rgba(251,245,234,.92))'][seed%5];
      return `<div class="w-full h-full" style="background:${bg}"><svg viewBox="0 0 64 64" class="w-full h-full"><path d="M16 36c2-12 10-20 16-20s14 8 16 20" fill="none" stroke="rgba(43,43,53,.65)" stroke-width="2.2" stroke-linecap="round"/><path d="M22 36c0 10 4 16 10 16s10-6 10-16" fill="none" stroke="rgba(43,43,53,.65)" stroke-width="2.2" stroke-linecap="round"/><circle cx="26" cy="32" r="2" fill="rgba(43,43,53,.65)"/><circle cx="38" cy="32" r="2" fill="rgba(43,43,53,.65)"/><path d="M28 41c2 2 6 2 8 0" fill="none" stroke="rgba(43,43,53,.5)" stroke-width="2.2" stroke-linecap="round"/><path d="M23 24l-5-5M41 24l5-5" fill="none" stroke="rgba(43,43,53,.5)" stroke-width="2.2" stroke-linecap="round"/></svg></div>`;
    }

    function svgIcon(kind, active=false, badge=false){
      const tint = active ? 'rgba(244,163,122,.85)' : 'rgba(43,43,53,.68)';
      const fill = active ? 'rgba(247,197,159,.45)' : 'rgba(134,166,139,.18)';
      // The Red Dot logic
      const badgeHtml = badge ? `<div class="absolute -top-1 -right-1 badge-dot"></div>` : '';
      
      const wrap = (inner, label) => `
        <div class="relative">
            <div class="mx-auto w-12 h-12 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 grid place-items-center ${active ? 'shadow-sm' : ''}">${inner}</div>
            <div class="mt-1 text-[11px] text-center ${active ? 'font-extrabold text-black/75' : 'text-black/55'}">${label}</div>
            ${badgeHtml}
        </div>`;

      if(kind==='feed') return wrap(`<svg class="w-7 h-7" viewBox="0 0 64 64"><rect x="14" y="16" width="36" height="32" rx="10" fill="${fill}" stroke="${tint}" stroke-width="2.2"/><path d="M22 38l7-8 7 8 6-6 6 6" fill="none" stroke="${tint}" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="26" cy="26" r="3" fill="none" stroke="${tint}" stroke-width="2.2"/></svg>`, 'Feed');
      if(kind==='stories') return wrap(`<svg class="w-7 h-7" viewBox="0 0 64 64"><path d="M20 14h22l6 6v30a6 6 0 0 1-6 6H20a6 6 0 0 1-6-6V20a6 6 0 0 1 6-6Z" fill="${fill}" stroke="${tint}" stroke-width="2.2"/><path d="M42 14v8h8" fill="none" stroke="${tint}" stroke-width="2.2"/><path d="M22 30h20M22 38h16" fill="none" stroke="${tint}" stroke-width="2.2"/></svg>`, 'Pages');
      if(kind==='messages') return wrap(`<svg class="w-7 h-7" viewBox="0 0 64 64"><path d="M16 24h32a6 6 0 0 1 6 6v18a6 6 0 0 1-6-6H16a6 6 0 0 1-6-6V30a6 6 0 0 1 6-6Z" fill="${fill}" stroke="${tint}" stroke-width="2.2"/><path d="M12 30l20 14 20-14" fill="none" stroke="${tint}" stroke-width="2.2"/><path d="M24 22l4-10h8l4 10" fill="none" stroke="${tint}" stroke-width="2.2"/></svg>`, 'Notes');
      if(kind==='notifs') return wrap(`<svg class="w-7 h-7" viewBox="0 0 64 64"><path d="M24 10h16l4 8v28a6 6 0 0 1-6 6H26a6 6 0 0 1-6-6V18l4-8Z" fill="${fill}" stroke="${tint}" stroke-width="2.2"/><path d="M24 18h16" fill="none" stroke="${tint}" stroke-width="2.2"/><path d="M32 26c4 4 4 10 0 14" fill="none" stroke="${tint}" stroke-width="2.2"/><path d="M30 27c-2 2-2 10 0 12" fill="none" stroke="${tint}" stroke-width="2.2" opacity=".9"/></svg>`, 'Lantern');
      if(kind==='profile') return wrap(`<svg class="w-7 h-7" viewBox="0 0 64 64"><path d="M14 24c8-10 28-10 36 0v26a6 6 0 0 1-6 6H20a6 6 0 0 1-6-6V24Z" fill="${fill}" stroke="${tint}" stroke-width="2.2"/><path d="M22 30c3-3 7-5 10-5s7 2 10 5" fill="none" stroke="${tint}" stroke-width="2.2"/><path d="M22 45c4-5 16-5 20 0" fill="none" stroke="${tint}" stroke-width="2.2"/><path d="M22 18l4-8h12l4 8" fill="none" stroke="${tint}" stroke-width="2.2"/></svg>`, 'Corner');
      return '';
    }

    function showView(viewId) {
        state.tab = viewId;

        // Auto-close chat if leaving messages tab
        if (viewId !== 'messages' && state.activeThreadId) {
            state.activeThreadId = null; 
            const chatHeader = document.getElementById('chatHeader');
            if(chatHeader) chatHeader.innerHTML = `<div class="font-extrabold text-sm opacity-50">Select a note to read</div>`;
            const chatMessages = document.getElementById('chatMessages');
            if(chatMessages) chatMessages.innerHTML = '';
            const chatInputArea = document.getElementById('chatInputArea');
            if(chatInputArea) chatInputArea.classList.add('hidden');
            renderMessages();
        }

        // Hide/Show sections
        ['feed', 'stories', 'messages', 'notifs', 'profile'].forEach(id => {
            const el = document.getElementById(`view-${id}`);
            if (el) el.classList.add('hidden');
        });
        const current = document.getElementById(`view-${viewId}`);
        if (current) current.classList.remove('hidden');
        
        // --- BADGE LOGIC ---
        // Check if there are any unread messages
        const hasUnreadNotes = state.threads.some(t => {
            const lastReadTime = state.lastRead[t.id] || 0;
            // A thread is unread if it has messages AND the newest one is newer than my last read time
            // AND the last message wasn't sent by me
            const lastMsg = t.messages[t.messages.length-1];
            return lastMsg && lastMsg.from === 'them' && t.timestamp > lastReadTime;
        });

        // Check if there are notifications
        const hasNotifs = state.notifications.length > 0;

        // Update Nav Icons
        $('#nav-feed').innerHTML = svgIcon('feed', viewId === 'feed');
        $('#nav-stories').innerHTML = svgIcon('stories', viewId === 'stories');
        $('#nav-messages').innerHTML = svgIcon('messages', viewId === 'messages', hasUnreadNotes);
        $('#nav-notifs').innerHTML = svgIcon('notifs', viewId === 'notifs', hasNotifs);
        $('#nav-profile').innerHTML = svgIcon('profile', viewId === 'profile');
        
        if(viewId === 'profile') renderProfile();
    }

    function postMediaHTML(p){
      const m = p.media;
      if(m?.type==='image' && m.mediaId) return `<img data-media-img="${m.mediaId}" class="w-full h-full object-cover" alt="Post photo" />`;
      if(m?.type==='video' && m.mediaId) return `<video data-media-video="${m.mediaId}" class="w-full h-full object-cover" playsinline controls preload="metadata"></video>`;
      const seed = m?.seed || Number(String(p.id||'').replace(/\D/g,'')) || 12;
      const pal = m?.palette || p.palette || 'sunset';
      return artSVG(seed, pal);
    }

    async function loadUsers() {
        try { const { data } = await sb.from('profiles').select('*'); if (data) state.allUsers = data; } catch (e) { console.error('Error loading users', e); }
    }
    async function loadNotifications() {
        if (!state.user) return;
        try { const { data } = await sb.from('notifications').select('*').eq('user_id', state.user.id).order('created_at', { ascending: false }); if (data) state.notifications = data; } catch (e) { }
    }
    async function loadThreads() {
        if (!state.user) return;
        try {
            // 1. Fetch Messages
            const { data: msgs } = await sb.from('messages')
                .select('*, profiles:from_id(username, seed)')
                .or(`to_id.eq.${state.user.id},from_id.eq.${state.user.id}`)
                .order('created_at', { ascending: true });

            // 2. NEW: Fetch Read History from Cloud
            const { data: reads } = await sb.from('thread_reads')
                .select('other_user_id, last_read_at')
                .eq('user_id', state.user.id);

            // 3. Map Read History to State
            if(reads) {
                reads.forEach(r => {
                    state.lastRead[r.other_user_id] = new Date(r.last_read_at).getTime();
                });
            }

            if (msgs) {
                const grouped = {};
                msgs.forEach(m => {
                    const otherId = m.from_id === state.user.id ? m.to_id : m.from_id;
                    if (!grouped[otherId]) {
                        const u = state.allUsers.find(x => x.id === otherId) || { username: 'Neighbor', seed: 1 };
                        grouped[otherId] = { 
                            id: otherId, 
                            user: u.username, 
                            seed: u.seed, 
                            // Add avatar_url here
                            avatar_url: u.avatar_url,
                            last: '', 
                            timestamp: 0, 
                            messages: [] 
                        };
                    }
                    grouped[otherId].messages.push({ from: m.from_id === state.user.id ? 'me' : 'them', text: m.content || '' });
                    grouped[otherId].last = m.content || 'Sent a note';
                    grouped[otherId].timestamp = new Date(m.created_at).getTime();
                });
                
                state.threads = Object.values(grouped).sort((a, b) => b.timestamp - a.timestamp);
                
                if(state.activeThreadId) {
                    const activeData = state.threads.find(t => t.id === state.activeThreadId);
                    if(activeData) renderChatMessages(activeData);
                }
            }
        } catch (e) { console.error("Load error", e); }
        renderMessages();
    }
    // FIX: LOAD STORIES FROM DB
    async function loadStories() {
        try {
            // Added avatar_url to the select query
            const { data, error } = await sb.from('stories')
                .select(`*, profiles(username, seed, avatar_url)`)
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            if (data) {
                state.stories = data.map(s => ({ 
                    id: s.id, 
                    user: s.profiles?.username || 'Anon', 
                    seed: s.profiles?.seed || 1, 
                    // Store the avatar URL
                    avatar_url: s.profiles?.avatar_url,
                    title: s.title || 'Journal Entry', 
                    time: timeAgo(new Date(s.created_at)), 
                    pages: Array.isArray(s.pages) ? s.pages : (s.pages ? [s.pages] : ['Empty page...'])
                }));
            }
        } catch(e) { state.stories = []; }
        renderStories();
    }
    async function loadHabits() {
        if(!state.user) return;
        try {
            const today = new Date().toDateString();
            const { data } = await sb.from('habits').select('*').eq('user_id', state.user.id).eq('date', today).single();
            if(data) state.habits[today] = data.data;
        } catch(e) { }
    }
    function loadDailyCheckin() {
        const mood = localStorage.getItem('dailyCheckin');
        if(mood) { $$('.moodPick').forEach(b => { if(b.dataset.mood === mood) b.classList.add('bg-white','ring-2','ring-black/10'); }); }
    }

    // --- APP LOGIC (UPDATED INIT) ---
    async function init() {
        // 1. Initialize Supabase
        try { sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch (e) { return; }
        
        // 2. Setup the Listener IMMEDIATELY
        sb.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session && !state.user) {
                handleLoginSuccess(session);
            }
        });

        // 3. Load basic app data
        loadDailyCheckin();
        wireEvents();
        
        // Non-blocking loads
        loadStories(); 
        loadHabits();
        loadUsers();
        setTimeout(updateComposeView, 100);

        // 4. Check for existing session or URL hash
        const { data } = await sb.auth.getSession();
        const hasHash = window.location.hash && window.location.hash.includes('access_token');

        if (data?.session) {
            if (!state.user) handleLoginSuccess(data.session);
        } 
        else if (hasHash) {
            console.log("Processing magic link...");
            toast("Verifying magic link...");
            setTimeout(() => {
                if (!state.user) {
                    toast("Link expired or valid session not found.");
                    $('#onboardingModal').classList.remove('hidden');
                    renderOnboarding();
                    history.pushState("", document.title, window.location.pathname + window.location.search);
                }
            }, 4000);
        } 
        else {
            $('#onboardingModal').classList.remove('hidden');
            renderOnboarding();
        }
    }

    async function handleLoginSuccess(session) {
        state.user = session.user;
        $('#onboardingModal').classList.add('hidden');
        if($('#logoutBtn')) $('#logoutBtn').classList.remove('hidden');
        await loadProfile();
        await loadMutedUsers(); // Load Mutes
        await loadHiddenPosts(); // NEW: Load Hidden Posts
        await loadShelf(); // NEW: Load Shelf
        await loadFeed();
        await loadDrawer();
        await loadNotifications();
        await loadThreads();
        
        renderNewThreadModal();

        initRealtime();
        showView('feed');
    }
    
    async function loadMutedUsers() {
        if(!state.user) return;
        try {
            const { data } = await sb.from('mutes').select('muted_user_id').eq('user_id', state.user.id);
            if(data) state.mutedUsers = data.map(m => m.muted_user_id);
        } catch(e) { console.error('Error loading mutes', e); }
    }
    
    // NEW: Load Hidden Posts
    async function loadHiddenPosts() {
        if(!state.user) return;
        try {
            const { data } = await sb.from('hidden_posts').select('post_id').eq('user_id', state.user.id);
            if(data) state.hiddenPosts = data.map(h => h.post_id);
        } catch(e) { }
    }
    
    // NEW: Load Shelf
    async function loadShelf() {
        if(!state.user) return;
        try {
            const { data } = await sb.from('shelf').select('id, text').eq('user_id', state.user.id).order('created_at', { ascending: false });
            if(data) state.savedPrompts = data; // Now array of objects {id, text}
        } catch(e) { }
    }

    async function loadProfile() {
        if(!state.user) return;
        let { data, error } = await sb.from('profiles').select('*').eq('id', state.user.id).single();
        if (error) {
            const newP = { id: state.user.id, username: state.user.email.split('@')[0], mood: 'sunset', seed: Math.floor(Math.random()*50) };
            const { data: c } = await sb.from('profiles').insert(newP).select().single();
            state.profile = c || newP;
        } else { state.profile = data; }
        if(state.profile) applyMood(state.profile.mood || 'sunset');
    }
    async function saveProfile() {
        const selectedMood = $('.setupMood.ring-2')?.dataset.m || state.profile.mood || 'sunset';
        const updates = { username: $('#setupName').value, pronouns: $('#setupPronouns').value, bio: $('#setupBio').value, mood: selectedMood };
        await sb.from('profiles').update(updates).eq('id', state.user.id);
        state.profile = { ...state.profile, ...updates };
        applyMood(selectedMood);
        $('#editProfileModal').classList.add('hidden'); 
        toast('Corner updated.'); 
        renderProfile();
    }
    function openEditProfile() { 
        $('#setupName').value = state.profile.username || ''; 
        $('#setupPronouns').value = state.profile.pronouns || ''; 
        $('#setupBio').value = state.profile.bio || ''; 
        const currentMood = state.profile.mood || 'sunset';
        $$('.setupMood').forEach(b => {
            if(b.dataset.m === currentMood) b.classList.add('ring-2', 'ring-black/10', 'bg-white');
            else b.classList.remove('ring-2', 'ring-black/10', 'bg-white');
        });
        $('#editProfileModal').classList.remove('hidden'); 
    }
    async function loadFeed() {
        // FIX: Added 'avatar_url' to the profiles(...) selection list
        let { data, error } = await sb.from('posts')
            .select(`*, profiles(username, seed, pronouns, avatar_url), stickers(sticker_type), comments(text, profiles(username))`)
            .order('created_at', { ascending: false });
            
        if (error) {
            console.warn("Using fallback feed.");
            // Also added avatar_url here for safety
            const res = await sb.from('posts')
                .select(`*, profiles(username, seed, pronouns, avatar_url), stickers(sticker_type)`).order('created_at', { ascending: false });
            data = res.data;
        }
        state.posts = data || [];
        renderPosts();
    }
    async function loadDrawer() {
        if(!state.user) return;
        try {
            const { data } = await sb.from('saved_posts').select('post_id');
            if(data) state.savedPostIds = data.map(x => x.post_id);
        } catch(e) {}
    }

    async function initRealtime() { 
        try { await sb.removeAllChannels(); } catch (e) {}

        const channel = sb.channel('cozy-updates');

        channel
            // --- 1. NEW POSTS ---
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'posts' }, async (payload) => {
                // Fetch the full post data (with user profile)
                const { data } = await sb.from('posts')
                    .select(`*, profiles(username, seed, pronouns, avatar_url), stickers(sticker_type), comments(text, profiles(username))`)
                    .eq('id', payload.new.id)
                    .single();
                
                if (data) {
                    state.posts.unshift(data); // Add to local data
                    const html = getPostHTML(data);
                    
                    // Inject after the banner
                    const container = $('#feed-container');
                    const banner = container.querySelector('.hand-card'); // The banner
                    if(banner) {
                        banner.insertAdjacentHTML('afterend', html);
                    } else {
                        container.insertAdjacentHTML('afterbegin', html);
                    }
                    toast('New cozy post just appeared!');
                }
            })

            // --- 2. NEW STICKERS ---
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'stickers' }, (payload) => {
                const pid = payload.new.post_id;
                const type = payload.new.sticker_type;
                
                // Visual Fly Effect for everyone looking at the post
                const postEl = document.getElementById(`post-${pid}`);
                if(postEl) {
                    const btn = postEl.querySelector(`button[onclick*="${type}"]`);
                    if(btn) {
                        // Fly animation
                        const fly = document.createElement('div'); fly.className = 'sticker-fly';
                        fly.innerHTML = STICKER_SVGS[type];
                        const rect = btn.getBoundingClientRect();
                        fly.style.left = (rect.left + window.scrollX) + 'px';
                        fly.style.top = (rect.top + window.scrollY) + 'px';
                        document.body.appendChild(fly);
                        setTimeout(() => fly.remove(), 1000);
                        
                        // Increment Counter in UI
                        const span = btn.querySelector('span:last-child');
                        if(span) span.innerText = parseInt(span.innerText) + 1;
                    }
                }
            })
            
            // --- 3. NEW COMMENTS ---
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'comments' }, async (payload) => {
                const pid = payload.new.post_id;
                // If comment modal is open for this post, refresh it
                if(state.comments.postId === pid) {
                     renderCommentsModal();
                }
                // Also update the preview on the card
                const previewContainer = document.getElementById(`comments-${pid}`);
                if(previewContainer) {
                    const { data: user } = await sb.from('profiles').select('username').eq('id', payload.new.user_id).single();
                    const html = `<div class="text-sm pop-in"><span class="font-extrabold">${user?.username}:</span> <span class="text-black/70">${payload.new.text}</span></div>`;
                    previewContainer.insertAdjacentHTML('afterbegin', html);
                }
            })

            // --- 4. NEW STORIES ---
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'stories' }, async (payload) => {
                 // Fetch story data
                 const { data } = await sb.from('stories').select(`*, profiles(username, seed, avatar_url)`).eq('id', payload.new.id).single();
                 if(data) {
                    // Convert to app format
                    const s = { 
                        id: data.id, 
                        user: data.profiles?.username, 
                        seed: data.profiles?.seed, 
                        avatar_url: data.profiles?.avatar_url,
                        title: data.title, 
                        time: 'Just now', 
                        pages: data.pages 
                    };
                    state.stories.unshift(s);
                    // Inject
                    const list = document.getElementById('storiesList');
                    list.insertAdjacentHTML('afterbegin', getStoryHTML(s, 0));
                 }
            })

            // --- 5. NOTIFICATIONS ---
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `user_id=eq.${state.user.id}` }, (payload) => {
                state.notifications.unshift(payload.new);
                // Show badge
                $('#nav-notifs').innerHTML = svgIcon('notifs', state.tab==='notifs', true);
                // Show toast
                toast(payload.new.content);
                // If on notifs view, render
                if(state.tab === 'notifs') renderNotifs();
            })

            // --- 6. MESSAGES (Keep your existing working logic here) ---
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, async (payload) => {
                const newMsg = payload.new;
                if (!newMsg) return;
                const isMe = newMsg.from_id === state.user.id;
                const partnerId = isMe ? newMsg.to_id : newMsg.from_id;
                let thread = state.threads.find(t => t.id === partnerId);
                if (!thread) {
                    let user = state.allUsers.find(u => u.id === partnerId);
                    if (!user) {
                        const { data } = await sb.from('profiles').select('*').eq('id', partnerId).single();
                        user = data || { username: 'Neighbor', seed: 1 };
                    }
                    thread = { id: partnerId, user: user.username, seed: user.seed, avatar_url: user.avatar_url, last: '', timestamp: Date.now(), messages: [] };
                    state.threads.push(thread);
                }
                thread.messages.push({ from: isMe ? 'me' : 'them', text: newMsg.content });
                thread.last = newMsg.content;
                thread.timestamp = new Date(newMsg.created_at).getTime();
                state.threads.sort((a, b) => b.timestamp - a.timestamp);
                if (state.activeThreadId === partnerId) {
                    state.lastRead[partnerId] = Date.now();
                    const container = $('#chatMessages');
                    if(container) {
                        if(container.innerText.includes("This paper is blank")) container.innerHTML = '';
                        container.innerHTML += `<div class="flex ${isMe ? 'justify-end' : 'justify-start'} pop-in"><div class="max-w-[85%] hand-card hand-outline border border-black/10 px-3 py-2 ${isMe ? 'bg-gradient-to-b from-[#86a68b]/35 to-white/75' : 'bg-white/75'}"><div class="text-sm text-black/80">${html(newMsg.content)}</div></div></div>`;
                        container.scrollTop = container.scrollHeight;
                    }
                } else if (!isMe) {
                    toast(`New note from ${thread.user}`);
                }
                renderMessages();
            })
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') console.log("üî• Everything Realtime Connected!");
            });
    }

    // --- HTML GENERATORS (For Realtime & Initial Load) ---

    function getPostHTML(p) {
        const u = p.profiles || { username: 'Anon', seed: 1 };
        const stickers = p.stickers || [];
        // Calculate counts
        const counts = { hug:0, star:0, leaf:0, spark:0, cocoa:0 }; 
        stickers.forEach(s => counts[s.sticker_type] = (counts[s.sticker_type]||0)+1);
        
        let art = artSVG(p.seed, p.palette); 
        if(p.image_url) art = `<img src="${p.image_url}" class="w-full h-full object-cover">`;
        
        const frameClass = p.frame === 'polaroid' ? 'bg-white/80 pb-8' : (p.frame === 'tape' ? 'bg-white/80' : 'bg-white/60 rounded-[22px]');
        const tapeDeco = p.frame === 'tape' ? `<div class="flex items-center justify-between -mt-1 mb-2"><div class="w-16 h-5 rounded-[10px_12px_14px_9px] bg-[#f7c59f]/60 border border-black/10 rotate-[-3deg]"></div><div class="w-12 h-5 rounded-[12px_10px_9px_14px] bg-[#b7cbb7]/55 border border-black/10 rotate-[4deg]"></div></div>` : '';
        const isSaved = state.savedPostIds.includes(p.id);
        const timeStr = timeAgo(new Date(p.created_at));
        const tags = inferTags(p.caption);
        const tagHtml = tags.map(t => `<span class="text-[10px] opacity-50 mr-1">#${t}</span>`).join('');
        const promptChip = p.prompt ? `<button onclick="saveToShelf('${html(p.prompt)}')" class="wobbly inline-flex items-center gap-2 px-3 py-1.5 rounded-[16px_14px_18px_12px] border border-black/10 bg-gradient-to-b from-[#fbf5ea] to-white/70 text-xs mb-2"><span class="inline-block w-2.5 h-2.5 rounded-full" style="background: rgba(244,163,122,.75)"></span>prompt: <b class="font-extrabold">${html(p.prompt)}</b><span class="text-[11px] text-black/45">save</span></button>` : '';
        
        // Comments preview
        const commentsHtml = (p.comments || []).slice(0, 2).map(c => `<div class="text-sm"><span class="font-extrabold">${html(c.profiles?.username || 'Someone')}:</span> <span class="text-black/70">${html(c.text)}</span></div>`).join('');

        return `
        <article class="hand-card hand-outline paper-noise p-4 relative mb-4 pop-in" id="post-${p.id}">
            <div class="absolute -right-10 -bottom-10 w-40 h-40 rounded-full pointer-events-none" style="background: radial-gradient(circle at 30% 30%, rgba(134,166,139,.18), rgba(219,161,168,.0) 60%);"></div>
            ${isSaved ? `<div class="absolute left-3 top-3 px-2 py-1 rounded-[14px] bg-white/75 text-[10px] font-extrabold border border-black/5">saved</div>` : ''}
            <div class="flex items-center justify-between gap-3 mb-3">
                <button onclick="openUserModal('${p.user_id}')" class="flex items-center gap-3 text-left wobbly">
                    <div class="w-11 h-11 rounded-[18px_16px_22px_14px] border border-black/10 overflow-hidden bg-white">${avatarHTML(u)}</div>
                    <div><div class="font-extrabold text-sm">${html(u.username)}</div><div class="text-xs text-black/50">${timeStr}</div></div>
                </button>
                <button onclick="openOptions('${p.id}', '${p.user_id}')" class="wobbly px-3 py-2 rounded-[14px] bg-white/50 border border-black/10 text-xs font-bold">‚Ä¢‚Ä¢‚Ä¢</button>
            </div>
            ${promptChip}
            <div class="relative mb-3 ${frameClass} hand-card hand-outline border border-black/5">
                ${tapeDeco}
                <div class="postMediaTap rounded-[16px] overflow-hidden border border-black/5 aspect-[4/3] bg-white/50 relative" data-postid="${p.id}" ondblclick="sendSticker('${p.id}', 'star', this)">
                        ${art}
                        <div class="absolute inset-0 z-10"></div>
                </div>
            </div>
            <div class="mb-1">${tagHtml}</div>
            <div class="text-sm text-black/80 mb-3 leading-snug">${html(p.caption)}</div>
            <div class="flex flex-wrap gap-2 mb-3" id="stickers-${p.id}">
                ${stickerBtn(p.id, 'hug', STICKER_SVGS.hug, counts.hug)}
                ${stickerBtn(p.id, 'star', STICKER_SVGS.star, counts.star)}
                ${stickerBtn(p.id, 'leaf', STICKER_SVGS.leaf, counts.leaf)}
                ${stickerBtn(p.id, 'spark', STICKER_SVGS.spark, counts.spark)}
                ${stickerBtn(p.id, 'cocoa', STICKER_SVGS.cocoa, counts.cocoa)}
            </div>
            <div class="hand-card hand-outline bg-white/70 border border-black/10 p-3">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-xs text-black/55">Supportive notes</div>
                    <button onclick="openComments('${p.id}')" class="wobbly px-3 py-1 rounded-[12px] bg-white border border-black/10 text-xs font-bold">Open</button>
                </div>
                <div class="space-y-1" id="comments-${p.id}">${commentsHtml || '<div class="text-sm text-black/55">No notes yet. Leave a gentle one?</div>'}</div>
            </div>
        </article>`;
    }

    function getStoryHTML(s, idx) {
        // Handle User Object
        const u = { username: s.user, seed: s.seed, avatar_url: s.avatar_url };
        
        return `
        <button class="w-full wobbly text-left pop-in" onclick="openStory(${idx})">
            <div class="hand-card hand-outline bg-white/70 border border-black/10 p-3 flex items-center gap-3">
                <div class="w-12 h-12 rounded-[18px_16px_22px_14px] border border-black/10 overflow-hidden bg-white">${avatarHTML(u)}</div>
                <div class="flex-1 min-w-0"><div class="font-extrabold truncate">${html(s.user)}'s pages</div><div class="text-xs text-black/55">${s.time} ‚Ä¢ ${s.pages.length} pages</div></div>
                <div class="text-xs text-black/50">open ‚Üí</div>
            </div>
        </button>`;
    }

    function renderPosts() {
        const list = $('#feed-container');
        
        // 1. Handle Filters visibility
        if (state.filter.search && state.filter.search.length > 0) $('#userFilterBanner').classList.remove('hidden');
        else $('#userFilterBanner').classList.add('hidden');
        
        // 2. Filter Logic
        const filtered = state.posts.filter(p => {
            const tags = inferTags(p.caption); 
            const matchesSearch = state.filter.search ? (p.caption.toLowerCase().includes(state.filter.search.toLowerCase()) || p.profiles.username.toLowerCase().includes(state.filter.search.toLowerCase())) : true;
            const matchesTopic = state.filter.topic === 'all' ? true : tags.includes(state.filter.topic);
            return matchesSearch && matchesTopic; 
        });

        // 3. Render
        if(filtered.length === 0) { 
            list.innerHTML = '<div class="p-6 text-center opacity-50">No posts found.</div>'; 
            return; 
        }

        const postsHtml = filtered.map(p => getPostHTML(p)).join('');
        list.innerHTML = postsHtml;
    }

    // Helper for stickers
    function stickerBtn(pid, type, svg, count) {
        return `<button onclick="sendSticker('${pid}','${type}',this)" class="wobbly inline-flex items-center gap-1 px-2 py-1 bg-white/70 border border-black/10 rounded-[12px] text-xs font-bold text-black/60 hover:bg-white">${svg} <span>${count || 0}</span></button>`;
    }

    function renderProfile() {
        if(!state.profile) return;
        const p = state.profile;
        const meId = state.user.id;
        
        const moodBtn = (id, l, g) => `<button class="moodBtn2 wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 ${p.mood===id ? 'bg-gradient-to-b from-white/80 to-white/60 ring-2 ring-black/10' : 'bg-white/70'}" data-mood="${id}"><span class="inline-flex items-center gap-2 text-xs font-extrabold"><span class="w-5 h-5 rounded-[10px_12px_12px_9px] border border-black/10" style="background:${g}"></span>${l}</span></button>`;
        const shelfIcon = `<svg viewBox="0 0 24 24" class="w-full h-full"><path class="ink-line-lite" d="M6 6h12v14H6z" fill="rgba(247,197,159,.25)"/><path class="ink-line-lite" d="M8 10h8M8 13h8M8 16h6" fill="none"/></svg>`;
        const plantIcon = `<svg viewBox="0 0 24 24" class="w-full h-full"><path class="ink-line-lite" d="M12 21c0-6 0-12 6-16-1 7-3 8-6 8" fill="none"/><path class="ink-line-lite" d="M12 21c0-6 0-12-6-16 1 7 3 8 6 8" fill="none"/><path class="ink-line-lite" d="M7 21h10" fill="none"/></svg>`;
        const windowIcon = `<svg viewBox="0 0 24 24" class="w-full h-full"><path class="ink-line-lite" d="M6 4h12v16H6z" fill="rgba(134,166,139,.18)"/><path class="ink-line-lite" d="M12 4v16M6 12h12" fill="none"/></svg>`;
        const drawerIcon = `<svg viewBox="0 0 24 24" class="w-full h-full"><path class="ink-line-lite" d="M5 7h14v12H5z" fill="rgba(219,161,168,.18)"/><path class="ink-line-lite" d="M5 12h14" fill="none"/><path class="ink-line-lite" d="M10 10h4" fill="none"/></svg>`;
        
        const roomItem = (t, s, i, r) => `<button class="roomBtn wobbly text-left" data-room="${r}" aria-label="Open ${t}"><div class="hand-card hand-outline bg-white/75 border border-black/10 p-3 h-full"><div class="w-8 h-8">${i}</div><div class="text-sm font-extrabold mt-1">${t}</div><div class="text-xs text-black/55">${s}</div></div></button>`;

        const myPosts = state.posts.filter(x => x.user_id === meId).slice(0, 8);
        const miniGallery = myPosts.map(post => `<button class="myPostThumb wobbly hand-card hand-outline bg-white/70 border border-black/10 p-2 text-left" data-postid="${post.id}"><div class="rounded-[16px_14px_18px_12px] overflow-hidden border border-black/10" style="aspect-ratio: 1 / 1">${postMediaHTML(post)}</div><div class="mt-2 text-[11px] text-black/60 line-clamp-2">${html(post.caption||'')}</div></button>`).join('');
        const savedPosts = state.savedPostIds.map(pid => state.posts.find(x => x.id === pid)).filter(Boolean).slice(0, 4);
        const savedThumbs = savedPosts.map(post => `<button class="savedPostThumb wobbly hand-card hand-outline bg-white/70 border border-black/10 p-2 text-left" data-postid="${post.id}"><div class="rounded-[16px_14px_18px_12px] overflow-hidden border border-black/10" style="aspect-ratio: 1 / 1">${postMediaHTML(post)}</div><div class="mt-2 text-[11px] text-black/60 line-clamp-2">${html(post.caption||'')}</div></button>`).join('');

        $('#view-profile').innerHTML = `
            <div class="relative hand-card hand-outline bg-gradient-to-b from-white/70 to-white/55 border border-black/10 p-4 overflow-hidden mb-4">
              <div class="absolute -left-10 -top-10 w-40 h-40 rounded-full" style="background: radial-gradient(circle at 30% 30%, rgba(219,161,168,.18), rgba(219,161,168,.0) 60%);"></div>
              
              <div class="flex items-center justify-between gap-3">
                <div class="min-w-0">
                    <!-- FIX: Show actual Name and Pronouns -->
                    <div class="font-[Fraunces] text-2xl tracking-tight leading-none mb-1">${html(p.username)}</div>
                    <div class="text-xs text-black/50 font-bold uppercase tracking-wider">${html(p.pronouns || 'Your Corner')}</div>
                </div>
                <!-- Avatar Display -->
                <div class="w-14 h-14 rounded-[20px_18px_26px_16px] border border-black/10 overflow-hidden shrink-0 bg-white">
                    ${avatarHTML(p)}
                </div>
              </div>

              <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-2">
                ${roomItem('Shelf', 'saved prompts', shelfIcon, 'shelf')}
                ${roomItem('Plant', 'soft habits', plantIcon, 'plant')}
                ${roomItem('Window', 'mood light', windowIcon, 'window')}
                ${roomItem('Drawer', `${state.savedPostIds.length} saved`, drawerIcon, 'drawer')}
              </div>

              <div class="mt-3 hand-card hand-outline bg-white/75 border border-black/10 p-3">
                <div class="flex items-center justify-between"><div><div class="font-extrabold">Mood lighting</div><div class="text-xs text-black/60">Pick the vibe that colors your corner.</div></div><div class="text-xs text-black/45">private</div></div>
                <div class="mt-2 flex flex-wrap gap-2">${moodBtn('sunset','Sunset','linear-gradient(135deg,#f4a37a,#f7c59f)')}${moodBtn('sage','Sage','linear-gradient(135deg,#86a68b,#b7cbb7)')}${moodBtn('berry','Berry','linear-gradient(135deg,#dba1a8,#c77d93)')}${moodBtn('clay','Clay','linear-gradient(135deg,#b87d66,#f4a37a)')}</div>
              </div>
              
              <div class="mt-3 hand-card hand-outline bg-white/75 border border-black/10 p-3">
                <div class="font-extrabold">About</div>
                <div class="text-sm text-black/70 mt-1">${html(p.bio||'')}</div>
                <div class="mt-2 flex flex-wrap items-center gap-2">
                    <button id="openProfileSetup" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold">Edit profile</button>
                    <button id="newPromptPost" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-gradient-to-b from-[#f7c59f] to-[#f4a37a] text-xs font-extrabold">Post a prompt</button>
                    <button id="newStory" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold">New journal page</button>
                </div>
              </div>
            </div>

            <div class="hand-card hand-outline paper-noise p-4">
                <div class="font-[Fraunces] text-lg mb-3">Your scrapbook</div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">${miniGallery}</div>
            </div>
            
            <div class="mt-4 hand-card hand-outline bg-white/70 border border-black/10 p-3">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm font-extrabold">Saved in your drawer</div>
                        <div class="text-xs text-black/60 mt-1">Posts you want to keep close (private).</div>
                    </div>
                    <button id="openDrawer2" class="wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold">Open</button>
                </div>
                <div class="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-3">${savedThumbs}</div>
            </div>
        `;
        
        $$('.roomBtn').forEach(btn => btn.onclick = () => openRoom(btn.dataset.room));
        $$('.moodBtn2').forEach(btn => { btn.onclick = async () => { const m = btn.dataset.mood; await setMood(m); }; });
        
        $('#openProfileSetup').onclick = openEditProfile;
        $('#newPromptPost').onclick = () => { $('#composeModal').classList.remove('hidden'); $('#composeCaption').value='What‚Äôs one kind thing you did today?\n\n'; toast('Prompt loaded.'); };
        $('#newStory').onclick = openStoryComposeModal;
        $('#openDrawer2').onclick = () => openRoom('drawer');
        $$('.myPostThumb').forEach(btn => btn.onclick = () => openOptions(btn.dataset.postid, state.user.id));
        $$('.savedPostThumb').forEach(btn => btn.onclick = () => openOptions(btn.dataset.postid, 'other'));
    }

    // UPDATED RENDER STORIES TO USE DB
    function renderStories() {
        const clubsHtml = MOCK_CLUBS.map(c => `
            <button class="hand-card paper-noise border border-black/10 p-3 text-left wobbly" onclick="state.filter.topic = '${c.tag}'; showView('feed'); toast('Peeking into ${c.title}');">
                <div class="font-extrabold text-sm">${c.title}</div>
                <div class="text-[10px] text-black/60">${c.desc}</div>
                <div class="mt-1 text-[9px] opacity-40">peek ‚Üí</div>
            </button>
        `).join('');
        document.getElementById('clubsContainer').innerHTML = `<div class="flex items-center justify-between mb-3"><div class="text-sm font-extrabold">Cozy Clubs</div></div><div class="grid grid-cols-2 gap-3">${clubsHtml}</div>`;

        const listDiv = document.getElementById('storiesList');
        if (state.stories.length === 0) {
            listDiv.innerHTML = `<div class="p-6 text-center opacity-50 text-sm">No journal pages found.<br>Be the first to write one?</div>`;
        } else {
            listDiv.innerHTML = state.stories.map((s, idx) => {
                // FIX: Define the user object 'u' here
                const u = { username: s.user, seed: s.seed, avatar_url: s.avatar_url };
                
                return `
                <button class="w-full wobbly text-left" onclick="openStory(${idx})">
                    <div class="hand-card hand-outline bg-white/70 border border-black/10 p-3 flex items-center gap-3">
                        <div class="w-12 h-12 rounded-[18px_16px_22px_14px] border border-black/10 overflow-hidden bg-white">${avatarHTML(u)}</div>
                        <div class="flex-1 min-w-0"><div class="font-extrabold truncate">${html(s.user)}'s pages</div><div class="text-xs text-black/55">${s.time} ‚Ä¢ ${s.pages.length} pages</div></div>
                        <div class="text-xs text-black/50">open ‚Üí</div>
                    </div>
                </button>
            `}).join('');
        }

        const promptsHtml = MOCK_PROMPTS.map(p => `
            <div class="wobbly hand-card hand-outline paper-noise border border-black/10 p-3">
              <div class="text-xs font-extrabold leading-snug mb-1">${p.title}</div><div class="text-[10px] text-black/60 mb-2">${p.desc}</div>
              <div class="flex gap-2"><button class="px-2 py-1 rounded border border-black/10 bg-white/70 text-[10px] font-bold" onclick="toast('Copied to composer')">Use</button><button class="px-2 py-1 rounded border border-black/10 bg-[#fbf5ea] text-[10px] font-bold" onclick="saveToShelf('${p.title}')">Save</button></div>
            </div>
        `).join('');
        document.getElementById('promptsGrid').innerHTML = promptsHtml;
    }

    function renderMessages() {
        const threadList = $('#threadList');
        if (state.threads.length === 0) { 
            threadList.innerHTML = `<div class="p-4 text-sm opacity-50">No notes yet.</div>`; 
            return; 
        }
        
        threadList.innerHTML = state.threads.map(t => {
            const active = state.activeThreadId === t.id;
            const lastMsg = t.messages[t.messages.length - 1];
            
            const lastReadTime = state.lastRead[t.id] || 0;
            const isNew = t.timestamp > lastReadTime;
            const isUnread = (lastMsg && lastMsg.from === 'them' && isNew && !active);
            
            const activeClass = active ? 'bg-gradient-to-b from-[#f7c59f]/55 to-white/70 ring-2 ring-[#f4a37a]/20' : 'bg-white/70';
            const unreadClass = isUnread ? 'border-[#f4a37a] shadow-sm' : 'border-black/10';
            const textWeight = isUnread ? 'font-bold text-black/90' : 'text-black/60';
            
            // FIX: Define the user object 'u' here
            const u = { username: t.user, seed: t.seed, avatar_url: t.avatar_url };

            return `
            <button class="w-full wobbly text-left mb-2" onclick="openThread('${t.id}')">
                <div class="hand-card hand-outline ${activeClass} ${unreadClass} border p-3 flex items-center gap-3 relative transition-all duration-300">
                    ${isUnread ? `<div class="absolute -top-1 -right-1 w-3 h-3 bg-[#f4a37a] rounded-full border-2 border-white shadow-sm"></div>` : ''}
                    <div class="w-11 h-11 rounded-[18px_16px_22px_14px] border border-black/10 overflow-hidden bg-white shrink-0">${avatarHTML(u)}</div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between gap-2">
                            <div class="font-extrabold truncate text-sm">${html(t.user)}</div>
                            <div class="text-[10px] opacity-40">${timeAgo(new Date(t.timestamp))}</div>
                        </div>
                        <div class="text-xs ${textWeight} truncate mt-0.5">${html(t.last)}</div>
                    </div>
                </div>
            </button>`;
        }).join('');
    }
    
    function renderNewThreadModal() {
        if(!state.user) return;
        const meId = state.user.id;
        const list = state.allUsers.filter(u => u.id !== meId);
        $('#userList').innerHTML = list.length ? list.map(u => `
            <button onclick="openThread('${u.id}')" class="w-full text-left p-3 hand-card bg-white/70 wobbly font-bold mb-2 flex items-center gap-3">
                <div class="w-8 h-8 rounded-[12px] border border-black/10 overflow-hidden bg-white">${avatarSVG(u.seed)}</div><span>${html(u.username)}</span>
            </button>
        `).join('') : '<div class="text-sm opacity-50 p-2">No other users found yet.</div>';
    }

    async function openThread(targetId) {
        // --- 1. TOGGLE LOGIC (Clicking same user closes chat) ---
        if (state.activeThreadId === targetId) {
            state.activeThreadId = null; // Deselect
            
            // Reset UI to "Empty" state
            $('#chatHeader').innerHTML = `<div class="font-extrabold text-sm opacity-50">Select a note to read</div>`;
            $('#chatMessages').innerHTML = '';
            $('#chatInputArea').classList.add('hidden'); // Hide input
            
            renderMessages(); // Re-render sidebar to remove orange highlight
            return; // Stop here
        }

        // --- 2. OPEN LOGIC ---
        state.activeThreadId = targetId;
        
        // Mark as READ in State (Instant UI update)
        const now = Date.now();
        state.lastRead[targetId] = now;
        
        // Mark as READ in Cloud (Persist across devices)
        // We use 'upsert' to either insert a new record or update the existing one
        sb.from('thread_reads').upsert({ 
            user_id: state.user.id, 
            other_user_id: targetId, 
            last_read_at: new Date().toISOString() 
        }).then(() => {}); // Fire and forget (don't await, keep UI snappy)

        renderMessages(); // Refresh sidebar to remove red dot

        const container = $('#chatMessages');
        container.innerHTML = ''; 

        // Find Data
        let thread = state.threads.find(t => t.id === targetId);
        let user = state.allUsers.find(u => u.id === targetId);
        
        // Header
        if(user) {
            $('#chatHeader').innerHTML = `<div class="flex items-center gap-2"><div class="w-8 h-8 rounded-[12px] border border-black/10 overflow-hidden bg-white">${avatarHTML(user)}</div><div class="font-extrabold text-sm">${html(user.username)}</div></div>`;
        }

        // Messages
        if(thread && thread.messages.length > 0) {
            renderChatMessages(thread);
        } else {
            container.innerHTML = `<div class="flex h-full items-center justify-center opacity-40 text-xs italic">This paper is blank.<br>Write a gentle note.</div>`;
        }

        // Reveal
        $('#chatInputArea').classList.remove('hidden');
        $('#newThreadModal').classList.add('hidden');
        container.scrollTop = container.scrollHeight;
    }

    function renderChatMessages(thread) {
        const container = $('#chatMessages');
        container.innerHTML = (thread.messages || []).map(m => {
            const isMe = m.from === 'me';
            return `<div class="flex ${isMe ? 'justify-end' : 'justify-start'}"><div class="max-w-[85%] hand-card hand-outline border border-black/10 px-3 py-2 ${isMe ? 'bg-gradient-to-b from-[#86a68b]/35 to-white/75' : 'bg-white/75'}"><div class="text-sm text-black/80">${html(m.text)}</div></div></div>`;
        }).join('');
        container.scrollTop = container.scrollHeight;
    }

    function renderNotifs() {
        const list = $('#notifList');
        if (state.notifications.length === 0) { list.innerHTML = `<div class="p-6 text-center opacity-40 italic">All quiet...</div>`; return; }
        list.innerHTML = state.notifications.map((n) => `
            <div class="hand-card hand-outline bg-white/70 border border-black/10 p-3 flex items-start gap-3 pop-in">
                <div class="w-10 h-10 rounded-[18px_16px_22px_14px] border border-black/10 bg-gradient-to-br from-[#f7c59f] via-[#fbf5ea] to-[#dba1a8] grid place-items-center">${notifIcon(n.type || 'sticker')}</div>
                <div class="flex-1"><div class="text-sm text-black/75">${html(n.content)}</div><div class="text-xs text-black/50 mt-1">${timeAgo(new Date(n.created_at))}</div></div>
            </div>`).join('');
    }

    // --- ACTIONS ---
    
    // UPDATED: Server-side Shelf logic
    async function saveToShelf(text) {
        if (!state.user) return;
        const exists = state.savedPrompts.find(p => p.text === text);
        if(!exists) {
            const { data } = await sb.from('shelf').insert({ user_id: state.user.id, text }).select().single();
            if(data) state.savedPrompts.unshift(data);
            toast('Saved to Shelf!');
        } else {
            toast('Already on Shelf');
        }
    }
    
    async function removeFromShelf(id) {
        state.savedPrompts = state.savedPrompts.filter(p => p.id !== id);
        openRoom('shelf'); // re-render
        await sb.from('shelf').delete().eq('id', id);
    }

    async function toggleHabit(habit) {
        const today = new Date().toDateString();
        if (!state.habits[today]) state.habits[today] = {};
        state.habits[today][habit] = !state.habits[today][habit];
        openRoom('plant'); 
        try { await sb.from('habits').upsert({ user_id: state.user.id, date: today, data: state.habits[today] }); } catch(e) {}
    }
    
    async function setMood(m) { 
        // 1. Apply visual change immediately
        applyMood(m); 
        state.profile.mood = m; 
        
        // 2. If the Window modal is open, re-render it to update the preview art
        const roomTitle = document.getElementById('roomTitle');
        if (roomTitle && roomTitle.innerText.includes('Window')) {
            openRoom('window'); // Re-renders the modal in place
        }
        
        // 3. Save to Cloud
        await sb.from('profiles').update({ mood: m }).eq('id', state.user.id); 
        
        toast(`Vibe set to ${m}`); 
        renderProfile(); // Update the profile page background
    }
    
    async function toggleSavePost() {
        const pid = state.activePostOption;
        const isSaved = state.savedPostIds.includes(pid);
        
        $('#postOptionsModal').classList.add('hidden');

        if (isSaved) {
            state.savedPostIds = state.savedPostIds.filter(id => id !== pid);
            toast('Removed from Drawer.');
            await sb.from('saved_posts').delete().eq('post_id', pid).eq('user_id', state.user.id);
        } else {
            state.savedPostIds.push(pid);
            toast('Saved to Drawer.');
            await sb.from('saved_posts').insert({ user_id: state.user.id, post_id: pid });
        }
        
        renderPosts();
        renderProfile();
    }
    
    async function toggleMuteUser() {
        const uid = state.activePostUser;
        const isMuted = state.mutedUsers.includes(uid);
        
        $('#postOptionsModal').classList.add('hidden');
        
        if (isMuted) {
            state.mutedUsers = state.mutedUsers.filter(id => id !== uid);
            toast('User unmuted.');
            await sb.from('mutes').delete().eq('user_id', state.user.id).eq('muted_user_id', uid);
        } else {
            state.mutedUsers.push(uid);
            toast('User muted.');
            await sb.from('mutes').insert({ user_id: state.user.id, muted_user_id: uid });
        }
        renderPosts();
    }
    
    function muteUser() { toggleMuteUser(); }
    
    // UPDATED: Server-side Hide logic
    async function hidePost() {
        const pid = state.activePostOption;
        const isHidden = state.hiddenPosts.includes(pid);
        
        $('#postOptionsModal').classList.add('hidden');
        
        if(isHidden) {
            state.hiddenPosts = state.hiddenPosts.filter(id => id !== pid);
            toast('Post unhidden.');
            await sb.from('hidden_posts').delete().eq('user_id', state.user.id).eq('post_id', pid);
        } else {
            state.hiddenPosts.push(pid);
            toast('Post hidden.');
            await sb.from('hidden_posts').insert({ user_id: state.user.id, post_id: pid });
        }
        renderPosts();
    }

    async function deletePost() {
        await sb.from('posts').delete().eq('id', state.activePostOption);
        $('#postOptionsModal').classList.add('hidden');
        loadFeed();
    }
    
    function reportPost() {
        $('#postOptionsModal').classList.add('hidden');
        openTextModal('Report Post', 'Is this unsafe or unkind?', 'Describe what happened...', (val) => {
            if(!val) return toast('Please describe the issue.');
            toast('Report submitted to admins.');
            return true;
        });
    }

    async function sharePost() {
        const p = state.posts.find(x => x.id === state.activePostOption);
        if(!p) return;
        const uname = p.profiles?.username || 'Someone';
        const text = `Cozy post by ${uname}: ${p.caption}`;
        const url = window.location.href; 
        
        try {
            if(navigator.share) {
                await navigator.share({ title: 'CozyGram', text, url });
                toast('Shared!');
            } else {
                await safeCopy(text + ' ' + url);
                toast('Link copied to clipboard.');
            }
        } catch(e) { }
        $('#postOptionsModal').classList.add('hidden');
    }

    function openOptions(pid, uid) { 
        state.activePostOption = pid; state.activePostUser = uid; 
        $('#postOptionsModal').classList.remove('hidden'); 
        
        const isSaved = state.savedPostIds.includes(pid);
        const saveBtn = $('#savePostBtn');
        if(saveBtn) {
            saveBtn.innerText = isSaved ? "Remove from Drawer" : "Save to Drawer";
            if(isSaved) saveBtn.classList.add('text-red-500'); else saveBtn.classList.remove('text-red-500');
        }
        
        const isMuted = state.mutedUsers.includes(uid);
        $('#muteUserBtn').innerText = isMuted ? "Unmute User" : "Mute User";
        
        const isHidden = state.hiddenPosts.includes(pid);
        $('#hidePostBtn').innerText = isHidden ? "Unhide Post" : "Hide Post";

        $('#deletePostBtn').classList.toggle('hidden', uid !== state.user.id); 
    }
    
    function renderCommentsModal(){
      const p = state.posts.find(x=>x.id===state.comments.postId);
      const listDiv = $('#commentsList');
      if(!p){ listDiv.innerHTML = ''; return; }
      
      const comments = p.comments || [];
      if(comments.length === 0) {
          listDiv.innerHTML = `<div class="hand-card p-3 bg-[#fff9c4] border border-black/5 rotate-[-1deg] wobbly"><b class="font-hand text-lg block mb-1 text-[#2b2b35]">Juniper</b><span class="font-hand text-lg">"This feels so calm üåø"</span></div><div class="text-xs text-black/40 text-center mt-2">(Example note)</div>`;
      } else {
          listDiv.innerHTML = comments.map(c => `<div class="hand-card hand-outline bg-white/70 border border-black/10 p-3"><div class="text-sm"><span class="font-extrabold">${html(c.profiles?.username || 'Someone')}:</span> <span class="text-black/70">${html(c.text)}</span></div></div>`).join('');
      }
    }
    
    function openComments(postId){ state.comments.postId = postId; openModal('commentsModal'); renderCommentsModal(); }
    $('#sendCommentBtn').onclick = async ()=>{ const val = $('#commentInput').value.trim(); if(!val) return; try { await sb.from('comments').insert({ post_id: state.comments.postId, user_id: state.user.id, text: val }); toast('Note sent.'); $('#commentInput').value = ''; } catch(e) { toast('Error sending note.'); } };
    
    function openEditProfile() { 
        $('#setupName').value = state.profile.username || ''; 
        $('#setupPronouns').value = state.profile.pronouns || ''; 
        $('#setupBio').value = state.profile.bio || ''; 
        
        // Show current avatar in the picker
        $('#editProfileAvatarPreview').innerHTML = avatarHTML(state.profile);

        const currentMood = state.profile.mood || 'sunset';
        $$('.setupMood').forEach(b => {
            if(b.dataset.m === currentMood) b.classList.add('ring-2', 'ring-black/10', 'bg-white');
            else b.classList.remove('ring-2', 'ring-black/10', 'bg-white');
        });
        $('#editProfileModal').classList.remove('hidden'); 
    }
    function closeCompose(){ $('#composeModal').classList.add('hidden'); state.compose.file = null; $('#mediaInput').value = ''; }

    async function openUserModal(userId) {
        const modal = document.getElementById('userModal');
        const body = document.getElementById('userModalBody');
        
        // 1. Show Loading State
        body.innerHTML = `<div class="p-8 text-center opacity-50 animate-pulse">Knocking on door...</div>`;
        modal.classList.remove('hidden');

        // 2. Fetch Fresh Data
        let user = state.allUsers.find(u => u.id === userId);
        try {
            const { data, error } = await sb.from('profiles').select('*').eq('id', userId).single();
            if (data) user = data;
        } catch(e) {}

        // Fallback if user barely exists
        user = user || { username: 'Neighbor', seed: 5, bio: '', pronouns: '', mood: 'sunset' };

        const meId = state.user.id;
        const isMe = userId === meId;
        const isMuted = state.mutedUsers.includes(userId);
        
        // 3. Get Recent Posts
        const recent = state.posts.filter(p => p.user_id === userId).slice(0, 6);
        
        // 4. Render
        body.innerHTML = `
            <div class="hand-card hand-outline bg-white/70 border border-black/10 p-3 mb-3">
              <div class="flex items-start gap-3">
                <div class="w-14 h-14 rounded-[20px_18px_26px_16px] border border-black/10 overflow-hidden shrink-0 bg-white">
                    ${avatarHTML(user)}
                </div>
                <div class="min-w-0 flex-1">
                  <div class="flex items-center gap-2 min-w-0">
                    <div class="font-extrabold truncate text-lg">${html(user.username)}</div>
                    <div class="text-xs text-black/45">${html(user.pronouns||'')}</div>
                  </div>
                  <div class="text-xs text-black/60 line-clamp-3 leading-snug mt-1">${html(user.bio||'A cozy corner.')}</div>
                  <div class="text-[10px] text-black/40 mt-2 font-bold uppercase tracking-wider">Mood: ${html(user.mood||'sunset')}</div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-2 mb-3">
              ${!isMe ? `
              <button id="userMsgBtn" class="wobbly px-3 py-3 rounded-[18px_16px_22px_14px] border border-black/10 bg-gradient-to-b from-[#f7c59f] to-[#f4a37a] font-extrabold text-white text-left shadow-sm">
                Message
                <div class="text-[10px] font-normal opacity-90">Send a note</div>
              </button>
              <button id="userMuteBtn" class="wobbly px-3 py-3 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 font-extrabold text-left">
                ${isMuted ? 'Unmute' : 'Mute'}
                <div class="text-[10px] font-normal text-black/50">${isMuted ? 'Allow posts' : 'Hide posts'}</div>
              </button>
              ` : `<div class="col-span-2 text-center text-xs text-black/40 py-2">This is your corner.</div>`}
              
              <button id="userFilterBtn" class="wobbly px-3 py-3 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 font-extrabold text-left">
                Filter
                <div class="text-[10px] font-normal text-black/50">Show only this</div>
              </button>
              <button id="userBioBtn" class="wobbly px-3 py-3 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 font-extrabold text-left">
                Copy Bio
                <div class="text-[10px] font-normal text-black/50">Save to clipboard</div>
              </button>
            </div>

            <div class="hand-card hand-outline bg-white/70 border border-black/10 p-3">
              <div class="flex items-center justify-between mb-2">
                <div class="text-xs font-extrabold opacity-50">RECENT SCRAPBOOK BITS</div>
              </div>
              <div class="grid grid-cols-3 gap-2">
                ${recent.map(p => `
                  <div class="wobbly rounded-[12px] overflow-hidden border border-black/10 bg-white aspect-square" onclick="toast('Use the feed to see full post')">
                    ${postMediaHTML(p)}
                  </div>
                `).join('') || `<div class="col-span-3 text-xs text-black/40 text-center py-4">No posts yet.</div>`}
              </div>
            </div>
        `;
        
        // Wire buttons
        const msgBtn = document.getElementById('userMsgBtn');
        if(msgBtn) msgBtn.onclick = () => { modal.classList.add('hidden'); openThread(userId); };

        const filterBtn = document.getElementById('userFilterBtn');
        if(filterBtn) filterBtn.onclick = () => {
            state.filter.search = user.username;
            document.getElementById('searchInput').value = user.username;
            modal.classList.add('hidden');
            renderPosts();
            toast(`Filtering by ${user.username}`);
        };

        const bioBtn = document.getElementById('userBioBtn');
        if(bioBtn) bioBtn.onclick = () => { safeCopy(user.bio); toast('Bio copied.'); };

        const muteBtn = document.getElementById('userMuteBtn');
        if(muteBtn) muteBtn.onclick = async () => {
            modal.classList.add('hidden');
            if (isMuted) {
                await unmuteUser(userId);
            } else {
                state.mutedUsers.push(userId);
                toast('User muted.');
                await sb.from('mutes').insert({ user_id: meId, muted_user_id: userId });
                renderPosts();
            }
        };

        modal.classList.remove('hidden');
    }
    
    function openAccountModal() {
        const p = state.profile || { username: 'Neighbor', seed: 0, pronouns: '', bio: '' };
        
        $('#accountBody').innerHTML = `
            <!-- Top Section: Avatar and Edit Button -->
            <div class="flex items-start justify-between gap-4 mb-4">
                <div class="flex items-center gap-4">
                    <!-- Actual Avatar -->
                    <div class="w-16 h-16 rounded-[22px_18px_26px_20px] border border-black/10 overflow-hidden bg-white shadow-sm shrink-0">
                        ${avatarHTML(p)}
                    </div>
                    <div class="min-w-0">
                        <!-- Full Name / Username -->
                        <div class="font-[Fraunces] text-xl truncate leading-tight">${html(p.username)}</div>
                        <!-- Pronouns -->
                        <div class="text-xs text-black/50 font-bold uppercase tracking-wider mt-1">
                            ${html(p.pronouns || 'Cozy Neighbor')}
                        </div>
                    </div>
                </div>
                
                <!-- Edit Profile Button at the Top (FIXED) -->
                <!-- We now manually hide the modal and call openEditProfile -->
                <button id="accountModalEditBtn" class="wobbly px-3 py-2 rounded-[14px_12px_16px_10px] border border-black/10 bg-white/80 text-xs font-extrabold shadow-sm">
                    Edit Profile
                </button>
            </div>

            <!-- Bio Section -->
            <div class="hand-card bg-white/50 border border-black/5 p-3 mb-4">
                <div class="text-[10px] font-bold text-black/40 uppercase tracking-widest mb-1">About your corner</div>
                <div class="text-sm text-black/75 leading-relaxed">
                    ${html(p.bio || 'No bio yet. Tap edit to add one!')}
                </div>
            </div>

            <!-- Settings / Actions List -->
            <div class="hand-card bg-white/70 border border-black/10 overflow-hidden">
                <div class="px-3 py-2 border-b border-black/5 text-[10px] font-bold text-black/30 uppercase tracking-widest">Settings</div>
                
                <button id="accountModalSafetyBtn" class="w-full text-left px-4 py-3 hover:bg-black/5 transition-colors flex items-center justify-between group">
                    <span class="text-sm font-bold text-black/70">Safety & Comfort</span>
                    <span class="text-xs opacity-0 group-hover:opacity-100 transition-opacity">‚Üí</span>
                </button>
                
                <button id="modalLogoutBtn" class="w-full text-left px-4 py-3 hover:bg-red-50 transition-colors flex items-center justify-between group">
                    <span class="text-sm font-bold text-red-500">Log Out</span>
                    <svg class="w-4 h-4 text-red-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
            </div>
        `;

        // --- WIRE UP BUTTONS SAFELY ---
        
        // 1. Edit Profile
        document.getElementById('accountModalEditBtn').onclick = () => {
            document.getElementById('accountModal').classList.add('hidden'); // Close this one
            openEditProfile(); // Open the edit screen
        };

        // 2. Safety
        document.getElementById('accountModalSafetyBtn').onclick = () => {
            document.getElementById('accountModal').classList.add('hidden');
            document.getElementById('safetyModal').classList.remove('hidden');
        };

        // 3. Logout
        const modalLogout = document.getElementById('modalLogoutBtn');
        if(modalLogout) {
            modalLogout.onclick = async () => {
                await sb.auth.signOut();
                window.location.href = window.location.pathname;
            };
        }

        // Show the modal
        $('#accountModal').classList.remove('hidden');
    }

    // --- PART 6: DYNAMIC COMPOSER VIEW ---
    function updateComposeView() {
        const container = $('#composePreviewContainer');
        const content = $('#composePreview');
        const artPicker = $('#artPicker');
        
        if(!container || !content) return; 
        
        // 1. Frame Logic (Visual Styles)
        container.className = 'rounded-[18px_16px_22px_14px] border border-black/10 flex items-center justify-center aspect-[4/3] overflow-hidden relative transition-all duration-300';
        
        // Remove old tape if exists
        const oldTape = container.querySelector('.tape-deco');
        if(oldTape) oldTape.remove();

        if (state.compose.frame === 'polaroid') {
            container.classList.add('bg-white', 'p-4', 'pb-10', 'shadow-sm');
        } else if (state.compose.frame === 'tape') {
            container.classList.add('bg-white/80', 'p-2');
            // Inject Tape
            const tape = document.createElement('div');
            tape.className = 'tape-deco absolute -top-3 left-1/2 -translate-x-1/2 w-16 h-5 bg-[#f7c59f]/80 rotate-[-2deg] border border-black/5 z-20 shadow-sm';
            container.appendChild(tape);
        } else {
             // Wavy / Default
             container.classList.add('bg-white/40');
        }

        // 2. Art Picker Rendering (Disable if media is uploaded)
        if (artPicker) {
            const isDisabled = !!state.compose.file;
            artPicker.innerHTML = illustChoices.map(ch => {
                const isSelected = (ch.seed == null && state.compose.illustSeed == null) || (state.compose.illustSeed === ch.seed);
                const previewSeed = ch.seed != null ? ch.seed : state.compose.seed;
                
                return `
                <button type="button" class="artBtn wobbly px-2.5 py-2 rounded-[18px_16px_22px_14px] border border-black/10 ${isSelected ? 'bg-white/85 ring-2 ring-black/10' : 'bg-white/70'} ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}" data-seed="${ch.seed || ''}">
                  <div class="w-12 h-9 rounded-[14px_12px_16px_10px] overflow-hidden border border-black/10 bg-white/40 pointer-events-none" style="aspect-ratio: 4/3">
                    ${artSVG(previewSeed, state.compose.vibe)}
                  </div>
                  <div class="mt-1 text-[11px] font-extrabold text-black/70 pointer-events-none">${html(ch.label)}</div>
                </button>`;
            }).join('');
            
            // Re-attach listeners
            $$('.artBtn').forEach(b => {
                b.onclick = () => {
                    if (state.compose.file) { toast('Remove photo to use art.'); return; }
                    const seedAttr = b.dataset.seed;
                    state.compose.illustSeed = seedAttr ? parseInt(seedAttr) : null;
                    updateComposeView();
                };
            });
        }

        

        // 3. Content Rendering (Image vs Video vs Illustration)
        content.innerHTML = ''; // Clear previous
        
        if (state.compose.file && state.compose.mediaPreviewUrl) {
             // --- SHOW MEDIA ---
             if(state.compose.mediaKind === 'video') {
                 content.innerHTML = `<video src="${state.compose.mediaPreviewUrl}" class="w-full h-full object-cover rounded-[12px]" playsinline controls></video>`;
             } else {
                 content.innerHTML = `<img src="${state.compose.mediaPreviewUrl}" class="w-full h-full object-cover rounded-[12px]" />`;
             }
             
             // Update the overlay label
             const overlay = container.querySelector('.absolute.bottom-2');
             if(overlay) {
                 overlay.innerHTML = `<button id="removeMediaBtn" class="bg-red-100 text-red-600 px-2 py-1 rounded text-[10px] font-bold shadow-sm border border-red-200">Remove Media</button>`;
                 document.getElementById('removeMediaBtn').onclick = (e) => {
                     e.preventDefault();
                     e.stopPropagation();
                     removeComposeMedia();
                 }
             }
        } else {
             // --- SHOW ART ---
             const currentSeed = state.compose.illustSeed !== null ? state.compose.illustSeed : state.compose.seed;
             content.innerHTML = artSVG(currentSeed, state.compose.vibe);
             
             // Reset overlay label
             const overlay = container.querySelector('.absolute.bottom-2');
             if(overlay) overlay.innerHTML = `Tap to upload`;
        }
    }

    function removeComposeMedia() {
        if(state.compose.mediaPreviewUrl) {
            try { URL.revokeObjectURL(state.compose.mediaPreviewUrl); } catch(e) {}
        }
        state.compose.file = null;
        state.compose.mediaPreviewUrl = null;
        state.compose.mediaKind = null;
        $('#mediaInput').value = ''; // Reset input
        updateComposeView();
        toast("Media removed.");
    }
    
    function getPlantSVG(pct) {
        // --- ASSETS (Based on the flat vector image) ---
        
        // 1. The Pot (Terracotta with thick rim and dark soil)
        // We use 'overflow: visible' to allow leaves to stretch out
        const pot = `
            <!-- Back of Pot Rim (Depth) -->
            <path d="M15 32 h18 l-1 3 h-16 z" fill="#BF360C" />
            <!-- Soil -->
            <ellipse cx="24" cy="32" rx="8" ry="2" fill="#3E2723" />
            <!-- Pot Body -->
            <path d="M17 35 h14 l-2 10 h-10 z" fill="#8D6E63" />
            <!-- Pot Rim Front -->
            <path d="M14 31 h20 v4 h-20 z" fill="#FF7043" />
            <path d="M14 35 h20 v1 h-20 z" fill="#BF360C" opacity="0.3" /> <!-- Shadow under rim -->
        `;

        // 2. Leaf Builder (Helper for two-tone leaves)
        // x,y = stem connection. r = rotation. s = scale.
        const leaf = (x, y, r, s) => `
            <g transform="translate(${x},${y}) rotate(${r}) scale(${s})">
                <!-- Dark Half -->
                <path d="M0 0 Q-10 -5 0 -15 Z" fill="#1B5E20" />
                <!-- Light Half -->
                <path d="M0 0 Q10 -5 0 -15 Z" fill="#66BB6A" />
            </g>
        `;

        // --- STAGES ---

        // Stage 1: Seed / Tiny Sprout (0-24%)
        if(pct < 25) { 
             return `<svg viewBox="0 0 48 48" class="w-full h-full drop-shadow-sm pop-in" style="overflow: visible;">
                ${pot}
                <!-- Tiny sprout poking out -->
                <path d="M24 32 q0 -3 0 -4" stroke="#388E3C" stroke-width="2" fill="none" />
                ${leaf(24, 29, -15, 0.4)}
            </svg>`;
        }

        // Stage 2: Sapling (25-49%)
        // Small stem, two small leaves
        if(pct < 50) { 
             return `<svg viewBox="0 0 48 48" class="w-full h-full drop-shadow-sm pop-in" style="overflow: visible;">
                <!-- Stem -->
                <path d="M24 32 q0 -10 0 -12" stroke="#388E3C" stroke-width="2.5" stroke-linecap="round" fill="none" />
                <!-- Leaves -->
                ${leaf(24, 26, -45, 0.7)}
                ${leaf(24, 24, 45, 0.7)}
                ${pot}
            </svg>`;
        }

        // Stage 3: Growing (50-74%)
        // Taller stem, 4 leaves
        if(pct < 75) { 
             return `<svg viewBox="0 0 48 48" class="w-full h-full drop-shadow-sm pop-in" style="overflow: visible;">
                <!-- Stem -->
                <path d="M24 32 q0 -15 -2 -18" stroke="#388E3C" stroke-width="3" stroke-linecap="round" fill="none" />
                <!-- Bottom Leaves -->
                ${leaf(24, 26, -50, 0.8)}
                ${leaf(24, 25, 50, 0.8)}
                <!-- Top Leaves -->
                ${leaf(23, 18, -30, 0.9)}
                ${leaf(23, 17, 30, 0.9)}
                ${pot}
            </svg>`;
        }

        // Stage 4: Full Plant (75-100%) - Matches your image
        // Tall stem, big lush leaves with two-tone shading
        return `<svg viewBox="0 0 48 48" class="w-full h-full drop-shadow-sm pop-in" style="overflow: visible;">
            <!-- Main Stem -->
            <path d="M24 32 C24 25, 24 15, 28 8" stroke="#388E3C" stroke-width="3" stroke-linecap="round" fill="none" />
            
            <!-- Bottom Leaves -->
            ${leaf(24, 26, -70, 0.8)} <!-- Left Down -->
            ${leaf(24, 25, 70, 0.8)}  <!-- Right Down -->
            
            <!-- Middle Leaves -->
            ${leaf(24, 18, -40, 1.1)} <!-- Left Mid -->
            ${leaf(25, 17, 40, 1.1)}  <!-- Right Mid -->
            
            <!-- Top Leaf (The big one) -->
            ${leaf(27, 10, -10, 1.3)} <!-- Top -->
            
            ${pot}
        </svg>`;
    }

    // UPDATED ROOM LOGIC (Shelf uses IDs now)
    async function openRoom(room) {
        // Handle "closing" if clicking the same room or close button (optional logic, but good for safety)
        const titleMap = { shelf: 'Your Shelf', plant: 'Your Plant', window: 'Your Window', drawer: 'Your Drawer' };
        $('#roomTitle').innerText = titleMap[room] || `Your ${room}`;
        
        let content = '';
        
        if (room === 'shelf') {
            if (state.savedPrompts.length === 0) {
                // Polished Empty State with TWO starter options (from Design file)
                content = `
                <div class="hand-card bg-white/70 border border-black/10 p-4">
                    <div class="font-extrabold mb-1">Your shelf is empty.</div>
                    <div class="text-sm text-black/70 mb-3">Save prompts from Stories to keep them here. Or start with one:</div>
                    <div class="flex flex-wrap gap-2">
                        <button class="seedPrompt wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold" data-text="One tiny thing I am proud of today">Save "Proud"</button>
                        <button class="seedPrompt wobbly px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 bg-white/70 text-xs font-extrabold" data-text="What I wish someone told me this week">Save "Wish"</button>
                    </div>
                </div>`;
            } else {
                content = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">${state.savedPrompts.map((p) => `
                    <div class="hand-card bg-white/75 border border-black/10 p-3 flex flex-col justify-between">
                        <div class="text-sm font-extrabold mb-2 leading-snug">${html(p.text)}</div>
                        <div class="flex items-center gap-2">
                            <button class="shelfUse wobbly px-3 py-2 rounded-[14px] border border-black/10 bg-gradient-to-b from-[#f7c59f] to-[#f4a37a] text-xs font-extrabold text-white" data-text="${html(p.text)}">Use</button>
                            <button class="shelfRemove wobbly px-3 py-2 rounded-[14px] border border-black/10 bg-white/70 text-xs font-extrabold text-red-400" data-id="${p.id}">Remove</button>
                        </div>
                    </div>`).join('')}</div>`;
            }
        } 
        else if (room === 'window') {
            const mood = state.profile.mood || 'sunset';
            // Live Preview Art
            const preview = artSVG(44, mood); 
            
            content = `
            <div class="hand-card bg-white/70 border border-black/10 p-4 mb-4">
                <div class="text-sm font-extrabold">A little light</div>
                <div class="text-sm text-black/70 mt-1">Choose a vibe. It recolors your corner (private).</div>
                
                <!-- The Preview Box -->
                <div class="mt-3 rounded-[18px_16px_22px_14px] overflow-hidden border border-black/10 bg-white/50 transition-all duration-500" style="aspect-ratio: 4/2">
                    ${preview}
                </div>
                
                <!-- Mood Buttons -->
                <div class="mt-3 flex flex-wrap gap-2">
                    ${['sunset','sage','berry','clay'].map(m => `
                        <button onclick="setMood('${m}')" class="px-3 py-2 rounded-[18px_16px_22px_14px] border border-black/10 text-xs font-extrabold wobbly capitalize ${mood===m ? 'bg-white/80 ring-2 ring-black/10' : 'bg-white/70'}">
                            ${m}
                        </button>
                    `).join('')}
                </div>
            </div>`;
        } 
        else if (room === 'plant') {
            // (Keep existing plant logic)
            const today = new Date().toDateString();
            const h = state.habits[today] || {};
            const habitsList = [{id: 'water', label: 'üíß Drink Water'}, {id: 'stretch', label: 'üßò Stretch (20s)'}, {id: 'sun', label: '‚òÄÔ∏è See Daylight'}, {id: 'kind', label: 'üíå Send a Kind Text'}, {id: 'tidy', label: 'üßπ Tidy 5 mins'}];
            const doneCount = habitsList.filter(x => h[x.id]).length;
            const pct = Math.round((doneCount / habitsList.length) * 100);
            const plantSvg = getPlantSVG(pct);

            content = `
            <div class="hand-card bg-[#f6fff8] p-4 border border-black/5 mb-4 relative overflow-hidden">
                <div class="absolute right-[-20px] top-[-20px] w-32 h-32 bg-yellow-100 rounded-full blur-2xl opacity-50"></div>
                <div class="flex justify-between items-center gap-4">
                    <div class="w-24 h-24 shrink-0 transition-all duration-500">${plantSvg}</div>
                    <div class="flex-1 min-w-0">
                        <div class="font-[Fraunces] text-lg leading-tight mb-1">Today‚Äôs Growth</div>
                        <div class="text-xs text-black/60 mb-2">${doneCount}/${habitsList.length} gentle actions completed</div>
                        <div class="w-full h-3 bg-black/5 rounded-full overflow-hidden border border-black/5"><div class="h-full bg-[#86a68b] transition-all duration-500 ease-out" style="width: ${pct}%"></div></div>
                    </div>
                </div>
                <div class="mt-3 flex justify-end"><button id="resetHabits" class="wobbly px-3 py-1.5 rounded-[12px] border border-black/10 bg-white/70 text-[10px] font-bold text-black/50 hover:text-red-500">Reset Day</button></div>
            </div>
            <div class="space-y-2">${habitsList.map(item => `<button class="habitToggle wobbly w-full text-left" data-habit="${item.id}"><div class="hand-card ${h[item.id] ? 'bg-gradient-to-r from-green-50 to-white' : 'bg-white/75'} border ${h[item.id] ? 'border-green-200' : 'border-black/10'} p-3 flex items-center justify-between gap-3 transition-colors"><div class="text-sm font-extrabold ${h[item.id] ? 'text-green-800' : 'text-black/80'}">${item.label}</div><div class="w-6 h-6 rounded-full border ${h[item.id] ? 'bg-green-500 border-green-600' : 'bg-white border-black/20'} grid place-items-center">${h[item.id] ? '<svg class="w-3.5 h-3.5 text-white" viewBox="0 0 24 24" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>' : ''}</div></div></button>`).join('')}</div>`;
        } 
        else if (room === 'drawer') {
            if (state.savedPostIds.length === 0) content = `<div class="p-6 text-center opacity-50">Tap ‚Ä¢‚Ä¢‚Ä¢ on a post to save it here.</div>`;
            else { const savedPosts = state.posts.filter(p => state.savedPostIds.includes(p.id)); content = `<div class="grid grid-cols-3 gap-2">${savedPosts.map(p => `<div class="aspect-square bg-white rounded-[12px] overflow-hidden border border-black/10 wobbly" onclick="toast('Viewing saved post')">${postMediaHTML(p)}</div>`).join('')}</div><div class="mt-4 text-center text-xs opacity-50">Showing ${savedPosts.length} saved items</div>`; }
        }
        
        $('#roomBody').innerHTML = content;
        
        // --- WIRING ---
        if (room === 'shelf') {
            $$('.shelfUse').forEach(b => b.onclick = () => { $('#roomModal').classList.add('hidden'); $('#composeModal').classList.remove('hidden'); $('#composeCaption').value = b.dataset.text + '\n\n'; });
            $$('.shelfRemove').forEach(b => b.onclick = () => removeFromShelf(b.dataset.id));
            // New: Handle multiple seed buttons
            $$('.seedPrompt').forEach(b => b.onclick = () => saveToShelf(b.dataset.text));
        }
        if (room === 'plant') {
            $$('.habitToggle').forEach(b => b.onclick = () => toggleHabit(b.dataset.habit));
            const resetBtn = $('#resetHabits');
            if(resetBtn) resetBtn.onclick = () => { delete state.habits[new Date().toDateString()]; localStorage.setItem('dailyHabits', JSON.stringify(state.habits)); openRoom('plant'); };
        }
        $('#roomModal').classList.remove('hidden');
    }
    
    // UPDATED STORY EVENTS
    function wireStoryEvents() {
        const prev = $('#prevStory'); const next = $('#nextStory');
        if (prev) prev.onclick = () => { if (state.storyPageIndex > 0) { state.storyPageIndex--; renderStoryModal(); } };
        if (next) next.onclick = () => { const s = state.stories[state.storyIndex]; if (s && state.storyPageIndex < s.pages.length - 1) { state.storyPageIndex++; renderStoryModal(); } else { $('#storyModal').classList.add('hidden'); } };
        
        $('#replyStoryBtn').onclick = () => {
            openTextModal('Reply with a note', 'A folded page for someone.', 'One gentle sentence is enough...', async (val) => { 
                if(!val) return false;
                try { 
                    const s = state.stories[state.storyIndex];
                    await sb.from('messages').insert({ from_id: state.user.id, content: `Replying to story: ${val}`, type: 'reply' }); 
                    toast('Reply sent.'); 
                } catch(e) { toast('Reply sent.'); }
                return true; 
            });
        };
    }
    
    function openStory(idx) {
        state.storyIndex = idx; state.storyPageIndex = 0;
        renderStoryModal();
        $('#storyModal').classList.remove('hidden');
    }

    // UPDATED STORY MODAL RENDER
    function renderStoryModal() {
        const s = state.stories[state.storyIndex];
        if(!s) return;
        const pageContent = s.pages[state.storyPageIndex];
        $('#storyAvatar').innerHTML = avatarSVG(s.seed);
        $('#storyTitle').innerText = `${s.user} ‚Ä¢ ${s.title}`;
        $('#storyMeta').innerText = `Page ${state.storyPageIndex + 1} of ${s.pages.length}`;
        const pageEl = $('#storyPage');
        pageEl.classList.remove('pageflip'); void pageEl.offsetWidth; pageEl.classList.add('pageflip');
        
        pageEl.innerHTML = `<div class="text-2xl mb-4 font-bold text-black/20 italic">~ ${state.storyPageIndex + 1} ~</div><div class="text-xl font-medium leading-relaxed">${html(pageContent)}</div><div class="mt-8 text-xs font-bold opacity-30 uppercase tracking-widest text-center">Cozy Journal ‚Ä¢ ${s.time}</div>`;
        $('#prevStory').disabled = (state.storyPageIndex === 0);
        $('#prevStory').style.opacity = (state.storyPageIndex === 0) ? '0.5' : '1';
        $('#nextStory').innerText = (state.storyPageIndex === s.pages.length - 1) ? 'Close' : 'Next';
    }
    
    function openStoryComposeModal() { $('#storyHeading').value = ''; $('#storyText').value = ''; $('#storyComposeModal').classList.remove('hidden'); }
    
    // UPDATED SAVE STORY
    async function saveStoryPage() {
        const heading = $('#storyHeading').value.trim(); const text = $('#storyText').value.trim();
        if (!heading || !text) return toast('Please add a heading and some text.');
        $('#storyComposeModal').classList.add('hidden');
        toast('Posting journal page...');
        try { 
            await sb.from('stories').insert({ user_id: state.user.id, title: heading, pages: [text] }); 
            toast('Journal page posted.'); 
            loadStories(); 
            $('#storyHeading').value = ''; 
            $('#storyText').value = '';
        } catch(e) { toast('Error posting.'); }
    }
    
    async function createPost() {
        const caption = $('#composeCaption').value; 
        if (!caption) return toast("Write a tiny note first.");
        
        $('#postNowBtn').innerText = "Compressing..."; // Visual feedback
        
        let imageUrl = null;
        let mediaType = null; // Track if it is image or video

        try {
            if (state.compose.file) {
                const file = state.compose.file;
                const isVideo = file.type.startsWith('video/');
                mediaType = isVideo ? 'video' : 'image';

                // 1. Compress (if it's an image)
                const fileToUpload = await compressImageToBlob(file);
                
                $('#postNowBtn').innerText = "Uploading...";

                // 2. Upload to Supabase
                const ext = isVideo ? 'mp4' : 'jpg';
                const name = `${state.user.id}/${Date.now()}.${ext}`;
                
                const { error } = await sb.storage.from('cozy-media').upload(name, fileToUpload);
                
                if (error) throw error;
                
                // 3. Get Public URL
                const { data } = sb.storage.from('cozy-media').getPublicUrl(name);
                imageUrl = data.publicUrl;
            }

            // 4. Save Post Record
            await sb.from('posts').insert({ 
                user_id: state.user.id, 
                caption, 
                image_url: imageUrl, 
                // Store metadata so we know how to render it later
                media: imageUrl ? { type: mediaType, mediaId: imageUrl } : null,
                frame: state.compose.frame, 
                palette: state.compose.vibe, 
                seed: state.compose.seed 
            });

            toast("Posted to Cloud!"); 
            $('#composeModal').classList.add('hidden'); 
            $('#composeCaption').value = ''; 
            state.compose.file = null; 
            $('#mediaInput').value = ''; // Reset file input
            loadFeed(); 
            
        } catch(e) {
            console.error(e);
            toast("Upload failed. Try a smaller file?");
        } finally {
            $('#postNowBtn').innerText = "Post to Cloud";
        }
    }

    async function sendSticker(pid, type, el) {
        // ... (keep the existing animation logic) ...
        const fly = document.createElement('div'); fly.className = 'sticker-fly';
        // ...
        
        try { 
            // 1. Save Sticker
            await sb.from('stickers').insert({ post_id: pid, sticker_type: type, user_id: state.user.id }); 
            
            // 2. Find Post Owner & Send Notification
            // We need to know who owns the post to notify them. 
            // Since we clicked a button, we can find the owner ID from state.posts
            const post = state.posts.find(p => p.id === pid);
            if(post && post.user_id !== state.user.id) {
                 await sb.from('notifications').insert({
                     user_id: post.user_id, // Notify the owner
                     type: 'sticker',
                     content: `${state.profile.username} sent a ${type} sticker!`
                 });
            }
        } catch(e) {}
        
        if(state.kindness) toast("Sticker sent with love.");
    }

    // RESTORED: Wire Events Function
    function wireEvents() {
        // Helper to attach listeners safely (prevents crashes if an element is missing)
        const safeWire = (id, fn) => {
            const el = $(id);
            if (el) el.onclick = fn;
            else console.warn(`Element ${id} not found, skipping.`);
        };
        
        const safeWireAll = (selector, fn) => {
            const els = $$(selector);
            if(els.length) els.forEach(fn);
        };

        // --- AUTH ---
        safeWire('#magicLinkBtn', async () => { 
            const email = $('#emailInput').value; 
            if(!email) return toast("Enter your email."); 
            $('#magicLinkBtn').innerText = "Sending..."; 
            const { error } = await sb.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } }); 
            if(error) { toast("Error sending."); $('#magicLinkBtn').innerText = "Try Again"; } 
            else { $('#loginMsg').innerText = "Check your inbox for the link!"; $('#magicLinkBtn').innerText = "Sent!"; } 
        });

        safeWire('#logoutBtn', async () => { 
            await sb.auth.signOut(); 
            // Clear URL and reload to a clean state
            window.location.href = window.location.pathname; 
        });

        // --- NAVIGATION ---
        safeWireAll('.navBtn', (b) => {
            b.onclick = () => {
                b.classList.add('wiggle');
                setTimeout(() => b.classList.remove('wiggle'), 700);
                showView(b.dataset.tab);
            };
        });

        // --- FAB & COMPOSE ---
        // NEW Post Button Logic
        safeWire('#newPostTrigger', () => { 
            $('#composeModal').classList.remove('hidden'); 
            state.compose.seed = Math.floor(Math.random()*100); 
            updateComposeView(); 
        });
        
        safeWire('#closeCompose', () => $('#composeModal').classList.add('hidden'));
        safeWire('#postNowBtn', createPost);
        
        safeWire('#mediaInput', (e) => { 
            const file = e.target.files[0];
            if(!file) return;
            if(state.compose.mediaPreviewUrl) URL.revokeObjectURL(state.compose.mediaPreviewUrl);
            state.compose.file = file;
            state.compose.mediaPreviewUrl = URL.createObjectURL(file);
            state.compose.mediaKind = file.type.startsWith('video/') ? 'video' : 'image';
            updateComposeView(); 
        });

        safeWireAll('.frameBtn', (b) => b.onclick = () => { state.compose.frame = b.dataset.f; updateComposeView(); });
        safeWireAll('.vibeBtn', (b) => b.onclick = () => { state.compose.vibe = b.dataset.v; updateComposeView(); });
        
        const captionInput = $('#composeCaption');
        if(captionInput) captionInput.oninput = (e) => { 
            const tags = inferTags(e.target.value); 
            $('#composeTags').innerHTML = tags.map(t => `<span class="text-[10px] bg-black/5 px-2 py-1 rounded-full text-black/50">#${t}</span>`).join(''); 
        };

        // --- ART PICKER ---
        const artPicker = $('#artPicker');
        if (artPicker) {
            artPicker.innerHTML = illustChoices.map(ch => `
                <button type="button" class="artBtn wobbly px-2 py-1 rounded-[10px] border border-black/10 bg-white/70 text-[10px] font-bold" data-seed="${ch.seed || ''}">
                    ${ch.label}
                </button>
            `).join('');
            
            safeWireAll('.artBtn', (b) => b.onclick = () => {
                if (state.compose.file) { toast('Remove photo to use art.'); return; }
                const seedAttr = b.dataset.seed;
                state.compose.illustSeed = seedAttr ? parseInt(seedAttr) : null;
                updateComposeView();
            });
        }

        // --- FEED & FILTERS ---
        safeWireAll('.topicBtn', (b) => b.onclick = () => { 
            state.filter.topic = b.dataset.t; 
            $$('.topicBtn').forEach(x => x.classList.remove('bg-white', 'ring-2', 'ring-black/10')); 
            b.classList.add('bg-white', 'ring-2', 'ring-black/10'); 
            renderPosts(); 
        });

        safeWire('#openAccount', openAccountModal);
        safeWire('#openSafety', () => $('#safetyModal').classList.remove('hidden'));
        safeWire('#kindToggle', () => { state.kindness = !state.kindness; $('#kindToggle2').innerText = state.kindness ? 'On' : 'Off'; toast(`Kindness: ${state.kindness?'On':'Off'}`); renderPosts(); });
        safeWire('#kindToggle2', () => { state.kindness = !state.kindness; $('#kindToggle2').innerText = state.kindness ? 'On' : 'Off'; renderPosts(); });
        safeWire('#numbersToggle', () => { state.hideNumbers = !state.hideNumbers; $('#numbersToggle').innerText = state.hideNumbers ? 'On' : 'Off'; renderPosts(); });

        // --- POST ACTIONS ---
        safeWire('#hidePostBtn', hidePost);
        safeWire('#deletePostBtn', async () => { if(confirm("Delete this?")) { await deletePost(); } });
        safeWire('#copyCaptionBtn', () => { const p = state.posts.find(x => x.id === state.activePostOption); if(p) { safeCopy(p.caption); toast('Copied.'); } $('#postOptionsModal').classList.add('hidden'); });
        safeWire('#reportPostBtn', reportPost);
        safeWire('#sharePostBtn', sharePost);
        safeWire('#savePostBtn', toggleSavePost);
        safeWire('#muteUserBtn', toggleMuteUser);

        // --- CHECKIN ---
        safeWire('#clearCheckin', () => { localStorage.removeItem('dailyCheckin'); $$('.moodPick').forEach(b => b.classList.remove('bg-white', 'ring-2')); });
        safeWireAll('.moodPick', (b) => b.onclick = () => { localStorage.setItem('dailyCheckin', b.dataset.mood); $$('.moodPick').forEach(x => x.classList.remove('bg-white', 'ring-2')); b.classList.add('bg-white', 'ring-2'); toast("Checked in."); });

        // --- PROFILE ---
        safeWire('#saveProfileSetup', saveProfile);
        
        const avatarInput = $('#avatarFileInput');
        if(avatarInput) avatarInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const tempUrl = URL.createObjectURL(file);
            const preview = $('#editProfileAvatarPreview');
            if(preview) preview.innerHTML = `<img src="${tempUrl}" class="w-full h-full object-cover">`;
            toast('Compressing & Uploading...');
            try {
                const compressed = await compressImageToBlob(file, 600, 0.8);
                const name = `avatars/${state.user.id}/${Date.now()}.jpg`;
                const { error } = await sb.storage.from('cozy-media').upload(name, compressed);
                if (error) throw error;
                const { data } = sb.storage.from('cozy-media').getPublicUrl(name);
                await sb.from('profiles').update({ avatar_url: data.publicUrl }).eq('id', state.user.id);
                state.profile.avatar_url = data.publicUrl;
                renderProfile();
                toast('New avatar set!');
            } catch (err) { console.error(err); toast('Error updating avatar.'); }
        };

        // --- MESSAGING ---
        safeWire('#chatSendBtn', async () => { 
            const txt = $('#chatInput').value.trim(); 
            const targetId = state.activeThreadId;
            if(!txt || !targetId) return; 
            $('#chatInput').value = ''; 
            try {
                const { error } = await sb.from('messages').insert({ from_id: state.user.id, to_id: targetId, content: txt });
                if(error) throw error;
            } catch(e) { toast('Error sending note.'); console.error(e); }
        });

        // --- COMMENTS (ADDED HERE) ---
        safeWire('#sendCommentBtn', async () => { 
            const input = $('#commentInput');
            const val = input.value.trim();
            if(!val) return; 

            try { 
                await sb.from('comments').insert({ post_id: state.comments.postId, user_id: state.user.id, text: val }); 
                
                // Notification Logic
                const post = state.posts.find(p => p.id === state.comments.postId);
                if(post && post.user_id !== state.user.id) {
                     await sb.from('notifications').insert({
                         user_id: post.user_id,
                         type: 'reply',
                         content: `${state.profile.username} left a note: "${val.substring(0, 20)}..."`
                     });
                }
                
                toast('Note sent.'); 
                input.value = ''; 
            } catch(e) { toast('Error sending note.'); console.error(e); } 
        });

        // --- MODALS & UTILS ---
        safeWire('#textModalSave', () => {
            const val = $('#textModalInput').value;
            if(state.textModal.onSave) {
               const success = state.textModal.onSave(val);
               if(success) closeTextModal();
            }
        });

        // --- ONBOARDING (This was likely crashing before) ---
        safeWire('#onboardBack', () => { if(state.onboardingStep > 0) { state.onboardingStep--; renderOnboarding(); } });
        safeWire('#onboardNext', () => { if(state.onboardingStep < 4) { state.onboardingStep++; renderOnboarding(); } });
        safeWire('#skipOnboarding', () => { state.onboardingStep = 4; renderOnboarding(); });

        wireStoryEvents();
        renderNewThreadModal();
    }
    
    function renderOnboarding() {
        const steps = [
            { text: "Welcome to CozyGram. Let me show you around.", pct: 0 },
            { text: "This is a quiet place. No follower counts here.", pct: 25 },
            { text: "We use stickers instead of likes to show warmth.", pct: 50 },
            { text: "Ready to find your cozy corner?", pct: 75 },
            { text: "Let's get you signed in.", pct: 100 }
        ];
        
        // Ensure state is valid
        if(isNaN(state.onboardingStep)) state.onboardingStep = 0;
        
        const current = steps[state.onboardingStep] || steps[0];
        const txt = document.getElementById('onboardText');
        if(txt) txt.innerText = current.text;

        const dots = document.getElementById('onboardDots');
        if(dots) dots.innerHTML = steps.map((_, i) => 
            `<div class="w-2 h-2 rounded-full transition-colors ${i === state.onboardingStep ? 'bg-[#f4a37a]' : 'bg-black/10'}"></div>`
        ).join('');

        const container = document.getElementById('authContainer');
        const nav = document.getElementById('onboardNav');
        const mascot = document.getElementById('mascot');

        if (state.onboardingStep === 4) {
             if(container) container.classList.remove('hidden');
             if(nav) nav.classList.add('hidden');
             if(mascot) mascot.classList.add('hidden'); 
        } else {
             if(container) container.classList.add('hidden');
             if(nav) nav.classList.remove('hidden');
             if(mascot) mascot.classList.remove('hidden');
        }
    }

    init();
  </script>
</body>
</html>
